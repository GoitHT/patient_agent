# RAG 库使用日志记录说明

## 概述

系统现已支持在患者日志中详细记录每个节点使用的 RAG（检索增强生成）向量库信息。

## 日志位置

患者日志文件保存在：`logs/patients/patient_{id}_{timestamp}.log`

## RAG 库类型

系统使用以下 4 个向量库：

| 库名称 | 数据库标识 | 用途 |
|--------|-----------|------|
| 医学指南库 | MedicalGuide_db | 存储医学指南、诊疗规范、检查指征等专业知识 |
| 临床案例库 | ClinicalCase_db | 存储真实临床案例，包含症状、检查结果、诊断和转归 |
| 高质量问答库 | HighQualityQA_db | 存储结构化的医患问答对，用于问诊参考 |
| 患者历史库 | UserHistory_db | 存储患者既往就诊记录、主诉、检查历史、历史检查开单记录等（用于个性化问诊和避免重复开单） |

## 日志格式示例

每次 RAG 检索都会在患者日志中记录以下信息：

```
📖 RAG 专科知识检索:
  🔍 查询: neurology 神经医学 红旗 检查建议 鉴别诊断
  🎯 过滤: dept=neurology
  ✅ 检索到 4 个知识片段
  📊 数据来源:
     • 医学指南库 (MedicalGuide_db): 3条
     • 高质量问答库 (HighQualityQA_db): 1条
  📝 相关内容预览（前3条）:
     [1] 相关度: 高 (0.892)
         内容: 神经内科红旗症状：突发剧烈头痛、意识障碍、肢体无力...
         科室: neurology
         类型: guideline
     [2] 相关度: 高 (0.856)
         内容: 神经系统检查适应症：头痛持续>2周、伴神经系统阳性体征...
     [3] 相关度: 中 (0.734)
         内容: 鉴别诊断要点：偏头痛 vs 紧张性头痛 vs 颅内占位...
```

## 各节点 RAG 使用情况

### 通用门诊流程

#### C5 - 问诊准备
- **使用库**: 医学指南库 + 患者历史库
- **检索内容**: 通用SOP、患者既往主诉和问答记录

#### C8 - 开单与准备说明
- **使用库**: 医学指南库 + 患者历史库
- **检索内容**: 检查准备知识、历史检查开单记录

#### C11 - 报告回诊
- **使用库**: 医学指南库 + 临床案例库
- **检索内容**: 诊疗方案、相似异常指标的临床案例

#### C12 - 综合分析诊断
- **使用库**: 医学指南库 + 临床案例库
- **检索内容**: 
  - 文书模板
  - 医院通用SOP
  - 专科随访方案
  - 相似临床案例

#### C14 - 生成文书
- **使用库**: 医学指南库 + 患者历史库
- **检索内容**: 文书模板、患者既往病历

#### C15 - 健康宣教与随访
- **使用库**: 医学指南库
- **检索内容**: 疾病科普、生活方式指导、随访计划

### 专科子图

#### S4 - 专科问诊
- **使用库**: 医学指南库 + 高质量问答库 + 临床案例库
- **检索内容**: 
  - 专科问诊要点和指南
  - 结构化问诊问题
  - 相似症状患者的问诊流程

#### S6 - 初步判断
- **使用库**: 医学指南库
- **检索内容**: 专科诊疗指南、检查指征与建议

## 如何查看 RAG 使用统计

1. 运行系统后，检查 `logs/patients/` 目录
2. 打开最新的患者日志文件
3. 搜索 `📖 RAG` 可以找到所有 RAG 检索记录
4. 查看 `📊 数据来源` 部分可以看到使用了哪些向量库
5. 每个节点的 RAG 检索都有明确的目的说明（如"专科知识检索"、"相似临床案例"等）

## 技术实现

- **日志函数**: `_log_rag_retrieval()` 在 `src/graphs/log_helpers.py`
- **数据来源**: RAG 检索器在 `src/rag/adaptive_rag_retriever.py` 中为每个检索结果添加 `source` 元数据
- **统计分析**: 日志函数自动统计各库的使用次数并按降序排列

## 示例：完整的节点 RAG 使用

以下是 S4 节点（专科问诊）的完整 RAG 日志示例：

```
▶ S4: 神经医学专科问诊
────────────────────────────────────────────────────────────────────────────────

📖 RAG 神经医学专科知识检索:
  🔍 查询: neurology 神经医学 红旗 检查建议 鉴别诊断
  🎯 过滤: dept=neurology
  ✅ 检索到 4 个知识片段
  📊 数据来源:
     • 医学指南库 (MedicalGuide_db): 4条

📖 RAG 高质量问诊参考检索:
  🔍 查询: 神经医学 专科问诊 问题 症状评估
  🎯 过滤: scenario=quality_qa
  ✅ 检索到 3 个知识片段
  📊 数据来源:
     • 高质量问答库 (HighQualityQA_db): 3条

📖 RAG 临床案例参考检索:
  🔍 查询: 神经医学 头痛 眩晕 麻木 发作
  🎯 过滤: scenario=clinical_case
  ✅ 检索到 2 个知识片段
  📊 数据来源:
     • 临床案例库 (ClinicalCase_db): 2条
```

## 注意事项

1. 如果某个检索没有找到相关内容，会显示 `ℹ️  未检索到相关内容`
2. 如果无法识别数据来源，会显示 `⚠️  未能识别数据来源`
3. 每次检索最多显示前 3 条结果的详细预览
4. 相关度评分范围 0-1，>0.8 为高相关，>0.6 为中相关，否则为低相关

## 后续优化

未来可以考虑：
- 添加 RAG 检索性能统计（检索耗时）
- 添加知识片段利用率统计（哪些片段被LLM实际引用）
- 支持导出 RAG 使用统计报告
