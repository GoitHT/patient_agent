# RAG 检索查询标准

**文档版本**: v2.0  
**更新日期**: 2026-02-12  
**状态**: ✅ 已实施

---

## 📋 总体标准

系统中所有节点的RAG查询均遵循以下统一标准，确保检索的针对性和精准性：

### 🔍 四大知识库查询标准

#### 1. 【医学指南库】MedicalGuide_db

**输入要素**：
- 患者主诉
- 关键症状
- 当前流程节点目标

**检索目标**：
- 诊断标准
- 治疗方案
- 决策依据
- 是否需要辅助检查的权威指南内容

**应用节点**: C12, S4, S6

---

#### 2. 【高质量对话库】HighQualityQA_db

**输入要素**：
- 患者主诉
- 当前问诊或解释阶段

**检索目标**：
- 结构化医患问诊对话
- 检查结果解读示例
- 沟通示例对话

**应用节点**: C11, S4

---

#### 3. 【临床案例库】ClinicalCase_db

**输入要素**：
- 患者主诉
- 关键症状
- 已完成检查

**检索目标**：
- 典型病例
- 结果解读案例
- 诊疗决策路径相关内容

**应用节点**: C11, C12, S4

---

#### 4. 【规则流程库】HospitalProcess_db

**输入要素**：
- 当前流程节点类型

**检索目标**：
- 标准操作规程
- 检查准备事项
- 医疗文书模板
- 宣教与随访流程

**应用节点**: C5, C8, C14, C15

---

## 🏥 各节点RAG查询详细规范

### 通用流程节点

#### C5 - 准备问诊

**知识库**: `HospitalProcess_db`

**输入**:
- 流程节点类型
- 科室

**输出**:
- 门诊就诊流程
- 问诊接诊SOP

**关键词示例**:
```
神经内科 门诊 就诊流程 问诊 接诊 标准操作规程 SOP
```

---

#### C8 - 开单与准备说明

**知识库**: `HospitalProcess_db`, `UserHistory_db`

**输入**:
- 流程节点类型
- 已开检查项目

**输出**:
- 检查准备注意事项
- 缴费预约流程
- 历史检查记录

**关键词示例**:
```
MRI 检查准备事项 注意事项 缴费流程 预约流程
```

---

#### C11 - 报告回诊

##### 高质量对话库查询

**知识库**: `HighQualityQA_db`

**输入**:
- 患者主诉
- 检查结果（特别是异常结果）

**输出**:
- 检查结果解读对话
- 医患沟通示例

**关键词示例**:
```
头痛头晕 MRI 白质病变 检查结果解读 医患沟通示例 结果说明对话
```

##### 临床案例库查询

**知识库**: `ClinicalCase_db`

**输入**:
- 患者主诉
- 科室
- 已完成检查
- 关键症状（异常结果）

**输出**:
- 典型病例
- 检查结果解读案例

**关键词示例**:
```
头痛头晕 神经内科 MRI 白质病变 典型病例 检查结果解读案例
```

---

#### C12 - 综合分析与诊断

##### 医学指南库查询

**知识库**: `MedicalGuide_db`

**输入**:
- 患者主诉
- 科室
- 关键症状（检查结果异常）
- 节点目标（综合诊断）

**输出**:
- 诊断标准
- 治疗方案
- 临床决策依据
- 权威指南

**关键词示例**:
```
头痛头晕 神经内科 MRI 白质病变 诊断标准 治疗方案 临床决策依据 权威指南
```

##### 临床案例库查询

**知识库**: `ClinicalCase_db`

**输入**:
- 患者主诉
- 科室
- 已完成检查
- 关键症状（异常结果）

**输出**:
- 典型病例
- 诊疗决策路径
- 临床案例分析

**关键词示例**:
```
头痛头晕 神经内科 MRI 白质病变 典型病例 诊疗决策路径 临床案例分析
```

---

#### C14 - 生成文书

**知识库**: `HospitalProcess_db`, `UserHistory_db`

**输入**:
- 流程节点类型
- 科室
- 初步诊断

**输出**:
- 医疗文书模板（门诊病历、诊断证明、病假条、宣教单）
- 患者历史病历信息

**关键词示例**:
```
神经内科 慢性脑血管病 医疗文书模板 门诊病历 诊断证明 病假条 宣教单
```

---

#### C15 - 宣教与随访

**知识库**: `HospitalProcess_db`

**输入**:
- 流程节点类型
- 科室
- 初步诊断

**输出**:
- 健康宣教流程
- 随访计划
- 注意事项
- 红旗症状

**关键词示例**:
```
神经内科 慢性脑血管病 健康宣教流程 随访计划 注意事项 红旗症状 患者教育
```

---

### 专科子图节点

#### S4 - 专科问诊

##### 医学指南库查询

**知识库**: `MedicalGuide_db`

**输入**:
- 科室
- 患者主诉
- 节点目标（专科问诊）

**输出**:
- 专科诊断标准
- 问诊要点
- Red Flags
- 鉴别诊断要点
- 临床决策

**关键词示例**:
```
神经内科 头痛头晕 专科诊断标准 问诊要点 Red Flags 鉴别诊断要点 临床决策
```

##### 高质量对话库查询

**知识库**: `HighQualityQA_db`

**输入**:
- 科室
- 患者主诉
- 阶段（专科问诊）

**输出**:
- 结构化问诊对话
- 医患问诊示例
- 专科问诊技巧

**关键词示例**:
```
神经内科 头痛头晕 结构化问诊 医患问诊示例 专科问诊对话 沟通技巧
```

##### 临床案例库查询

**知识库**: `ClinicalCase_db`

**输入**:
- 科室
- 患者主诉

**输出**:
- 典型病例
- 诊疗决策参考
- 临床案例

**关键词示例**:
```
神经内科 头痛头晕 典型病例 诊疗决策参考 临床案例
```

---

#### S6 - 初步判断

**知识库**: `MedicalGuide_db`

**输入**:
- 患者主诉
- 科室
- 关键症状（从专科小结提取）
- 节点目标（初步判断）

**输出**:
- 诊断标准
- 鉴别诊断
- 辅助检查决策依据
- 临床指南

**关键词示例**:
```
头痛头晕 神经内科 持续性 中度 诊断标准 鉴别诊断 是否需要辅助检查 检查决策依据 临床指南
```

---

## 🎯 实施要点

### 1. 关键词生成原则

- **充分利用患者上下文**: 主诉、症状、检查结果、诊断等
- **明确节点目标**: 每个节点有明确的检索目的
- **避免医学推理**: 只生成关键词，不进行诊断或治疗推理
- **区分知识库特性**: 不同知识库有不同的检索策略

### 2. 检索优先级

1. **患者主诉**: 最核心的检索要素
2. **关键症状**: 从检查结果、专科小结中提取
3. **节点目标关键词**: 根据节点功能添加目标导向词
4. **科室信息**: 提供专科背景

### 3. 质量控制

- ✅ 每个节点必须有明确的输入输出定义
- ✅ 关键词必须基于患者实际信息
- ✅ 禁止使用泛化的、跨节点的关键词
- ✅ 检索结果必须与节点目标相关

---

## 📊 覆盖节点汇总

| 节点 | 知识库 | 标准状态 |
|------|--------|----------|
| C5   | Process | ✅ 已实施 |
| C8   | Process, History | ✅ 已实施 |
| C11  | QA, Case | ✅ 已实施 |
| C12  | Guide, Case | ✅ 已实施 |
| C14  | Process, History | ✅ 已实施 |
| C15  | Process | ✅ 已实施 |
| S4   | Guide, QA, Case | ✅ 已实施 |
| S6   | Guide | ✅ 已实施 |

---

## 🔧 技术实现

### 代码位置

- **关键词生成器**: `src/rag/keyword_generator.py`
- **检索器**: `src/rag/adaptive_rag_retriever.py`

### 核心类

- `RAGKeywordGenerator`: 负责根据节点上下文生成针对性关键词
- `AdaptiveRAGRetriever`: 负责执行多知识库检索

### 使用示例

```python
from src.rag.keyword_generator import RAGKeywordGenerator, NodeContext

# 创建节点上下文
ctx = NodeContext(
    node_id="C12",
    node_name="综合分析与诊断",
    dept="neurology",
    dept_name="神经内科",
    chief_complaint="头痛头晕3天",
    test_results=[
        {
            "test_name": "头颅MRI",
            "abnormal": True,
            "summary": "脑白质病变"
        }
    ]
)

# 生成关键词
generator = RAGKeywordGenerator()
keywords = generator.generate_keywords(ctx, "MedicalGuide_db")
print(keywords)
# 输出: "头痛头晕3天 神经内科 头颅MRI 脑白质病变 诊断标准 治疗方案 临床决策依据 权威指南"
```

---

## ✅ 验证与测试

### 验证方法

1. **语法检查**: 
   ```bash
   python -m py_compile src/rag/keyword_generator.py
   ```

2. **单元测试**: 创建测试用例验证每个节点的关键词生成

3. **端到端测试**: 在实际流程中验证检索结果的相关性

### 质量指标

- ✅ 关键词必须包含患者主诉
- ✅ 关键词必须反映节点目标
- ✅ 检索结果的相关性 > 80%
- ✅ 无跨节点混淆

---

## 📝 维护说明

### 新增节点时

1. 在 `RAGKeywordGenerator.NODE_RETRIEVAL_GOALS` 中添加节点配置
2. 为每个知识库实现 `_generate_{node_id}_{db_name}` 方法
3. 添加详细的docstring说明输入输出
4. 更新本文档的节点汇总表

### 修改标准时

1. 更新类文档顶部的标准描述
2. 更新相关节点方法的docstring
3. 更新本文档
4. 执行完整测试验证

---

**文档结束**
