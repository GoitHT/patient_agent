"""åŒ»ç”Ÿæ™ºèƒ½ä½“ï¼šåŸºäºRAGçŸ¥è¯†åº“è¿›è¡Œé—®è¯Šã€å¼€å•ã€è¯Šæ–­"""
from __future__ import annotations

import json
from typing import Any

from rag import ChromaRetriever
from services.llm_client import LLMClient
from utils import get_logger


class DoctorAgent:
    """åŒ»ç”Ÿæ™ºèƒ½ä½“ï¼šåˆå§‹ä¸çŸ¥é“ä»»ä½•ç—…ä¾‹ä¿¡æ¯ï¼Œé€šè¿‡é—®è¯Šè·å–"""
    
    def __init__(
        self,
        dept: str,
        retriever: ChromaRetriever,
        llm: LLMClient | None = None,
        max_questions: int = 10  # æœ€åº•å±‚é»˜è®¤å€¼ï¼Œé€šå¸¸ç”±config.yamlè¦†ç›–
    ):
        """
        Args:
            dept: ç§‘å®¤ä»£ç  (ä¾‹å¦‚: neurology)
            retriever: RAGæ£€ç´¢å™¨
            llm: è¯­è¨€æ¨¡å‹å®¢æˆ·ç«¯
            max_questions: æœ€å¤šé—®é¢˜æ•°ï¼ˆé€šå¸¸ä»config.yamlè¯»å–ï¼‰
        """
        self.dept = dept
        self._retriever = retriever
        self._llm = llm
        self._max_questions = max_questions
        self._logger = get_logger("hospital_agent.doctor")
        self.collected_info: dict[str, Any] = {
            "chief_complaint": "",
            "symptoms": [],
            "duration": "",
            "history": {},
            "exam_findings": {},
            "conversation_history": []  # æ–°å¢ï¼šå®Œæ•´çš„å¯¹è¯å†å²ï¼ˆé—®é¢˜+å›ç­”ï¼‰
        }
        self.questions_asked: list[str] = []
    
    def reset(self) -> None:
        """é‡ç½®åŒ»ç”ŸçŠ¶æ€ï¼ˆç”¨äºå¤„ç†æ–°æ‚£è€…ï¼‰
        
        æ¸…ç©ºæ‰€æœ‰ä¸ä¸Šä¸€ä¸ªæ‚£è€…ç›¸å…³çš„çŠ¶æ€ï¼Œç¡®ä¿æ¯ä¸ªæ–°æ‚£è€…éƒ½ä»é›¶å¼€å§‹é—®è¯Šï¼š
        - collected_info: æ¸…ç©ºå·²æ”¶é›†çš„æ‚£è€…ä¿¡æ¯
        - questions_asked: æ¸…ç©ºå·²é—®é—®é¢˜åˆ—è¡¨ï¼ˆé¿å…é‡å¤é—®é¢˜æ£€æŸ¥æ—¶è¯¯åˆ¤ï¼‰
        
        âš ï¸ å¤šæ‚£è€…å¤„ç†æ—¶å¿…é¡»è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¦åˆ™ä¼šå‡ºç°ï¼š
          1. é—®é¢˜é‡å¤æ£€æŸ¥å¤±æ•ˆï¼ˆä»¥ä¸ºå·²ç»é—®è¿‡ï¼Œå®é™…æ˜¯ä¸Šä¸ªæ‚£è€…é—®çš„ï¼‰
          2. é—®è¯Šå†å²æ±¡æŸ“ï¼ˆæ˜¾ç¤ºé”™è¯¯çš„å†å²è®°å½•ï¼‰
        """
        self.collected_info = {
            "chief_complaint": "",
            "symptoms": [],
            "duration": "",
            "history": {},
            "exam_findings": {},
            "conversation_history": []  # ç¡®ä¿é‡ç½®æ—¶æ¸…ç©ºå†å²å¯¹è¯
        }
        # âš ï¸ å…³é”®ï¼šæ¸…ç©ºå·²é—®é—®é¢˜åˆ—è¡¨
        self.questions_asked = []
        self._logger.debug(f"åŒ»ç”Ÿ Agent å·²é‡ç½®ï¼šcollected_info + questions_asked å·²æ¸…ç©º")
    
    def generate_one_question(
        self,
        chief_complaint: str,
        context: str = "",
        rag_chunks: list[dict[str, Any]] | None = None
    ) -> str:
        """é€æ­¥ç”Ÿæˆå•ä¸ªé—®é¢˜ï¼ˆä¸€é—®ä¸€ç­”æ¨¡å¼ï¼‰
        
        Args:
            chief_complaint: ä¸»è¯‰
            context: å½“å‰é—®è¯Šä¸Šä¸‹æ–‡ï¼ˆå¦‚"æ¶ˆåŒ–å†…ç§‘ä¸“ç§‘é—®è¯Š"ï¼‰
            rag_chunks: RAGæ£€ç´¢åˆ°çš„çŸ¥è¯†ç‰‡æ®µ
            
        Returns:
            å•ä¸ªé—®é¢˜å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸éœ€è¦ç»§ç»­é—®åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        """
        # æ£€æŸ¥æ˜¯å¦å·²é—®è¶³å¤Ÿé—®é¢˜
        if len(self.questions_asked) >= self._max_questions:
            return ""
        
        # æ„å»ºRAGä¸Šä¸‹æ–‡
        kb_context = ""
        if rag_chunks:
            kb_context = self._format_chunks(rag_chunks)
        elif context:
            # å¦‚æœæ²¡æœ‰æä¾›chunksï¼Œå°è¯•æ£€ç´¢
            chunks = self._retriever.retrieve(
                f"{self.dept} {context} é—®è¯Šè¦ç‚¹",
                filters={"dept": self.dept},
                k=3
            )
            kb_context = self._format_chunks(chunks)
        
        # æ„å»ºå†å²å¯¹è¯å±•ç¤º - åŒ…æ‹¬é—®é¢˜å’Œæ‚£è€…çš„å›ç­”
        is_first_question = len(self.questions_asked) == 0
        
        if self.questions_asked:
            # æ˜¾ç¤ºå®Œæ•´çš„å¯¹è¯å†å²ï¼ˆé—®é¢˜ + å›ç­”ï¼‰
            conversation_history = self.collected_info.get("conversation_history", [])
            
            if conversation_history:
                # å¦‚æœæœ‰å®Œæ•´çš„å¯¹è¯è®°å½•ï¼Œæ˜¾ç¤ºé—®é¢˜å’Œå›ç­”
                history_lines = []
                for i, conv in enumerate(conversation_history, 1):
                    history_lines.append(f"ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿç¬¬{i}é—®: {conv.get('question', '')}")
                    history_lines.append(f"ğŸ‘¤ æ‚£è€…å›ç­”: {conv.get('answer', '')[:100]}{'...' if len(conv.get('answer', '')) > 100 else ''}")
                    history_lines.append("")  # ç©ºè¡Œåˆ†éš”
                history_display = "\n".join(history_lines)
            else:
                # å¦‚æœæ²¡æœ‰å¯¹è¯è®°å½•ï¼Œåªæ˜¾ç¤ºé—®é¢˜åˆ—è¡¨
                history_display = "\n".join([f"  {i+1}. {q}" for i, q in enumerate(self.questions_asked)])
            
            asked_summary = f"""â›” **å·²é—®è¿‡çš„æ‰€æœ‰é—®é¢˜åŠæ‚£è€…å›ç­”ï¼ˆå…±{len(self.questions_asked)}ä¸ªï¼‰**

{history_display}

âš ï¸ **ç»å¯¹ç¦æ­¢é‡å¤ï¼**
- ä»¥ä¸Šæ¯ä¸€ä¸ªé—®é¢˜éƒ½å·²ç»é—®è¿‡ï¼Œç»å¯¹ä¸èƒ½å†é—®ï¼
- ä¸èƒ½é—®è¯­ä¹‰ç›¸åŒæˆ–ç›¸ä¼¼çš„é—®é¢˜ï¼ˆå³ä½¿æ¢ä¸ªè¯´æ³•ä¹Ÿä¸è¡Œï¼‰
- **ä»…å½“æ‚£è€…çš„å›ç­”ä¸å®Œæ•´æ—¶ï¼Œæ‰å¯ä»¥é’ˆå¯¹å›ç­”ä¸­çš„å…·ä½“å†…å®¹æ·±å…¥è¿½é—®**
- å¦‚æœæ‚£è€…å·²ç»å›ç­”äº†è¯¥é—®é¢˜ï¼Œå°±ä¸è¦å†é—®ç›¸å…³å†…å®¹ï¼
- å¦‚æœæƒ³ä¸å‡ºæ–°é—®é¢˜ï¼Œå°±è¿”å›ç©ºå­—ç¬¦ä¸²åœæ­¢é—®è¯Šï¼

ğŸ’¡ **å¦‚ä½•åˆ¤æ–­æ˜¯å¦é‡å¤**ï¼š
1. æ£€æŸ¥ä½ æƒ³é—®çš„å†…å®¹æ˜¯å¦å·²ç»åœ¨æ‚£è€…çš„å›ç­”ä¸­å‡ºç°
2. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸ä¼¼çš„é—®é¢˜ï¼ˆå³ä½¿è¡¨è¿°ä¸åŒï¼‰
3. å¦‚æœæ‚£è€…å·²ç»æåˆ°è¿‡æŸä¸ªç—‡çŠ¶ï¼Œå°±ä¸è¦å†é—®â€œæœ‰æ²¡æœ‰è¿™ä¸ªç—‡çŠ¶â€

ğŸ“ **æ·±å…¥è¿½é—®ç¤ºä¾‹**ï¼š
- å·²é—®ï¼šâ€œæœ‰å“ªé‡Œä¸èˆ’æœï¼Ÿâ€ æ‚£è€…ç­”ï¼šâ€œå¤´ç–¼â€
  âœ… å…è®¸ï¼šâ€œå¤´å“ªä¸ªä½ç½®ç–¼ï¼Ÿå‰é¢ã€åè„‘å‹ºè¿˜æ˜¯ä¸¤ä¾§ï¼Ÿâ€
  âŒ ç¦æ­¢ï¼šâ€œè¿˜æœ‰åˆ«çš„ä¸èˆ’æœå—ï¼Ÿâ€ï¼ˆè¿™æ˜¯æ–°é—®é¢˜ï¼Œä¸æ˜¯æ·±å…¥è¿½é—®ï¼‰

- å·²é—®ï¼šâ€œç–¼ç—›ä¼šæ‰©æ•£åˆ°å…¶ä»–åœ°æ–¹å—ï¼Ÿâ€ æ‚£è€…ç­”ï¼šâ€œä¼šï¼Œæœ‰æ—¶å€™ä¼šåˆ°åèƒŒâ€
  âœ… å…è®¸ï¼šâ€œåèƒŒçš„å“ªä¸ªä½ç½®ï¼Ÿæ˜¯ä¸€ç›´ç–¼è¿˜æ˜¯å¶å°”ç–¼ï¼Ÿâ€
  âŒ ç¦æ­¢ï¼šâ€œç–¼ç—›çš„èŒƒå›´å¤§å—ï¼Ÿâ€ï¼ˆä¸å·²é—®é—®é¢˜é‡å¤ï¼‰
"""
        else:
            asked_summary = """ğŸ¯ **é¦–æ¬¡é—®è¯Š - å¼€æ”¾å¼é—®é¢˜ç­–ç•¥**

è¿™æ˜¯æ‚£è€…ç¬¬ä¸€æ¬¡è§åˆ°ä½ ï¼Œä½ è¿˜ä¸äº†è§£æ‚£è€…çš„ä»»ä½•æƒ…å†µã€‚
çœŸå®åŒ»ç”Ÿçš„åšæ³•æ˜¯ï¼šå…ˆç”¨å¼€æ”¾å¼é—®é¢˜è®©æ‚£è€…è‡ªå·±æè¿°ï¼Œè€Œä¸æ˜¯ç›´æ¥é—®å¾ˆå…·ä½“çš„åŒ»å­¦é—®é¢˜ã€‚

âœ… **æ¨èçš„é¦–æ¬¡é—®é¢˜**ï¼ˆé€‰ä¸€ä¸ªï¼‰ï¼š
- "æ‚¨å¥½ï¼Œå“ªé‡Œä¸èˆ’æœï¼Ÿ" 
- "æ‚¨å¥½ï¼Œä»Šå¤©æ¥çœ‹ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
- "æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆä¸èˆ’æœçš„å—ï¼Ÿ"
- "æ‚¨å¥½ï¼Œè·Ÿæˆ‘è¯´è¯´æ‚¨çš„æƒ…å†µå§ã€‚"

âš ï¸ **é¦–æ¬¡é—®è¯Šç¦å¿Œ**ï¼š
âŒ ä¸è¦ç›´æ¥é—®å¾ˆå…·ä½“çš„é—®é¢˜ï¼ˆå¦‚"ç–¼ç—›æŒç»­å¤šä¹…äº†ï¼Ÿ" - æ‚£è€…è¿˜æ²¡è¯´ç–¼ç—›å‘¢ï¼‰
âŒ ä¸è¦ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼ˆå¦‚"æ”¾å°„ç—›"ã€"è§¦ç—›" - æ‚£è€…å¯èƒ½ä¸æ‡‚ï¼‰
âŒ ä¸è¦ä¸€æ¬¡é—®å¤šä¸ªé—®é¢˜ï¼ˆè®©æ‚£è€…å…ˆè¯´å®Œä¸»è¦é—®é¢˜ï¼‰
âŒ ä¸è¦å‡è®¾æ‚£è€…çš„ç—‡çŠ¶ï¼ˆåº”è¯¥è®©æ‚£è€…è‡ªå·±æè¿°ï¼‰

ğŸ’¡ **åç»­é—®è¯Šç­–ç•¥**ï¼š
- ç¬¬1-2ä¸ªé—®é¢˜ï¼šå¼€æ”¾å¼ï¼Œè®©æ‚£è€…æè¿°ä¸»è¦ç—‡çŠ¶
- ç¬¬3-5ä¸ªé—®é¢˜ï¼šé’ˆå¯¹æ‚£è€…æåˆ°çš„ç—‡çŠ¶ï¼Œè¿½é—®å…³é”®ç»†èŠ‚ï¼ˆæ—¶é—´ã€ç¨‹åº¦ã€æ€§è´¨ï¼‰
- ç¬¬6-8ä¸ªé—®é¢˜ï¼šç­›æŸ¥å±é™©ä¿¡å·ã€ä¼´éšç—‡çŠ¶ã€æ—¢å¾€ç—…å²
- ç¬¬9-10ä¸ªé—®é¢˜ï¼šè¡¥å……æš´éœ²å²ã€é‰´åˆ«è¯Šæ–­å…³é”®ç‚¹
"""
        
        system_prompt = f"""ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„{self._dept_name()}åŒ»ç”Ÿï¼Œæ­£åœ¨è¿›è¡Œ{context}ã€‚ä½ éœ€è¦é€šè¿‡ç³»ç»Ÿçš„é—®è¯Šæ”¶é›†å…³é”®ä¿¡æ¯ï¼Œåšå‡ºå‡†ç¡®è¯Šæ–­ã€‚

âš ï¸ æ‚£è€…çŠ¶æ€æ„ŸçŸ¥
- è§‚å¯Ÿæ‚£è€…çš„å›ç­”ï¼šå¦‚æœç®€çŸ­ã€å«ç³Šæˆ–è¡¨ç°ç—›è‹¦ï¼Œè¯´æ˜çŠ¶æ€ä¸ä½³ï¼Œåº”ä¼˜å…ˆé—®æœ€å…³é”®çš„é—®é¢˜
- ç–¼ç—›å‰§çƒˆæˆ–æåº¦ç–²åŠ³æ—¶ï¼šç«‹å³è½¬å‘æ ¸å¿ƒé—®é¢˜ï¼ˆç—‡çŠ¶æ€§è´¨ã€æŒç»­æ—¶é—´ã€å±é™©å¾è±¡ï¼‰ï¼Œé¿å…ç»†ææœ«èŠ‚
- æ„è¯†å¼‚å¸¸æˆ–ç—…æƒ…å±é‡ï¼šåœæ­¢å¸¸è§„é—®è¯Šï¼Œå»ºè®®ç´§æ€¥å¤„ç†

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ä¸»è¯‰ã€‘
{chief_complaint}

ã€å·²æ”¶é›†çš„ä¿¡æ¯ã€‘
{json.dumps(self.collected_info, ensure_ascii=False, indent=2)}

ã€é—®è¯Šå†å²ã€‘({len(self.questions_asked)}/{self._max_questions}ï¼‰
{asked_summary}

ã€ä¸´åºŠçŸ¥è¯†å‚è€ƒã€‘
{kb_context}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš« **é‡å¤é—®é¢˜æ£€æµ‹ - æ ¸å¿ƒåŸåˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**

âš ï¸ åœ¨ç”Ÿæˆæ–°é—®é¢˜å‰ï¼Œä½ å¿…é¡»æ‰§è¡Œä»¥ä¸‹ä¸¥æ ¼æ£€æŸ¥æµç¨‹ï¼š

**æ­¥éª¤1ï¼šé€ä¸€æ ¸å¯¹å·²é—®é—®é¢˜**
ä»”ç»†é˜…è¯»ã€é—®è¯Šå†å²ã€‘ä¸­åˆ—å‡ºçš„æ¯ä¸€ä¸ªé—®é¢˜ï¼Œé€æ¡æ£€æŸ¥ä½ æƒ³ç”Ÿæˆçš„é—®é¢˜æ˜¯å¦ä¸ä»»ä½•ä¸€ä¸ªå·²é—®é—®é¢˜åœ¨ä»¥ä¸‹ç»´åº¦é‡å¤ï¼š
- è¯­ä¹‰é‡å¤ï¼šè¯¢é—®çš„å†…å®¹å®è´¨ç›¸åŒï¼ˆå¦‚"æ˜¯å¦æ‰©æ•£"å’Œ"æœ‰æ— æ‰©æ•£ç°è±¡"ï¼‰
- æ„å›¾é‡å¤ï¼šç›®çš„ç›¸åŒä½†è¡¨è¿°ä¸åŒï¼ˆå¦‚"ç–¼ç—›ç¨‹åº¦"å’Œ"ç–¼ç—›æ‰“å‡ åˆ†"ï¼‰
- éƒ¨åˆ†é‡å¤ï¼šè¯¢é—®çš„æŸä¸ªæ–¹é¢å·²åŒ…å«åœ¨ä¹‹å‰çš„é—®é¢˜ä¸­

**æ­¥éª¤2ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºæ·±å…¥è¿½é—®**
å¦‚æœä½ æƒ³é—®çš„å†…å®¹ä¸å·²é—®é—®é¢˜ç›¸å…³ï¼Œå¿…é¡»ç¡®ä¿æ˜¯åŸºäºå·²æœ‰ç­”æ¡ˆçš„æ·±å…¥è¿½é—®ï¼š
- âœ… å…è®¸ï¼šæ‚£è€…å·²å›ç­”"ç–¼ç—›ä¼šæ‰©æ•£"ï¼Œè¿½é—®"å…·ä½“æ‰©æ•£åˆ°å“ªäº›éƒ¨ä½ï¼Ÿ"
- âŒ ç¦æ­¢ï¼šæ‚£è€…å·²å›ç­”"ç–¼ç—›ä¼šæ‰©æ•£"ï¼Œå†é—®"ç–¼ç—›æœ‰æ²¡æœ‰æ”¾å°„åˆ°å…¶ä»–åœ°æ–¹ï¼Ÿ"ï¼ˆè¯­ä¹‰é‡å¤ï¼‰

**æ­¥éª¤3ï¼šé‡å¤é—®é¢˜è¯†åˆ«è§„åˆ™**
ä»¥ä¸‹æƒ…å†µéƒ½å±äºé‡å¤ï¼Œä¸¥ç¦ç”Ÿæˆï¼š
1. **æ¢è¯é‡è¿°**ï¼šç”¨ä¸åŒè¯æ±‡è¡¨è¾¾ç›¸åŒé—®é¢˜
   - å·²é—®"æ˜¯å¦æ‰©æ•£åˆ°å…¶ä»–éƒ¨ä½ï¼Ÿ" âŒ "æœ‰æ²¡æœ‰æ‰©æ•£ç°è±¡ï¼Ÿ" âŒ "ä¼šä¸ä¼šæ”¾å°„åˆ°åˆ«çš„åœ°æ–¹ï¼Ÿ"
   
2. **é‡åŒ–æ–¹å¼é‡å¤**ï¼šå·²ç»é—®è¿‡å®šé‡æˆ–å®šæ€§è¯„ä¼°
   - å·²é—®"ç–¼ç—›ç¨‹åº¦å¦‚ä½•ï¼Ÿ" âŒ "èƒ½ç»™ç–¼ç—›æ‰“ä¸ªåˆ†å—ï¼Ÿ" âŒ "ç–¼ç—›å‰å®³å—ï¼Ÿ"
   
3. **å› ç´ é‡å¤**ï¼šå·²ç»è¯¢é—®è¿‡åŠ é‡/ç¼“è§£/è¯±å‘å› ç´ 
   - å·²é—®"æ¥è§¦ä»€ä¹ˆä¼šåŠ é‡ï¼Ÿ" âŒ "æœ‰ä»€ä¹ˆå› ç´ ä¼šè¯±å‘æˆ–åŠ é‡å—ï¼Ÿ" âŒ "ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæ›´ä¸¥é‡ï¼Ÿ"
   
4. **æ—¶é—´é‡å¤**ï¼šå·²ç»é—®è¿‡æŒç»­æ—¶é—´ã€å‘ä½œé¢‘ç‡ã€æ—¶é—´è§„å¾‹
   - å·²é—®"æŒç»­å¤šä¹…äº†ï¼Ÿ" âŒ "ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿ" âŒ "ç—‡çŠ¶å‡ºç°å¤šé•¿æ—¶é—´ï¼Ÿ"

5. **ä¼´éšç—‡çŠ¶é‡å¤**ï¼šå·²ç»å…¨é¢è¯¢é—®è¿‡å…¶ä»–ç—‡çŠ¶
   - å·²é—®"è¿˜æœ‰å…¶ä»–ä¸èˆ’æœå—ï¼Ÿ" âŒ "ä¼´éšä»€ä¹ˆç—‡çŠ¶ï¼Ÿ" âŒ "æœ‰åˆ«çš„å¼‚å¸¸å—ï¼Ÿ"

**æ‰§è¡Œè¦æ±‚**ï¼š
- ç”Ÿæˆé—®é¢˜å‰ï¼Œå¿…é¡»åœ¨å¿ƒä¸­é€æ¡æ£€æŸ¥ä¸Šè¿°5ç±»é‡å¤æ¨¡å¼
- å¦‚æœå­˜åœ¨ä»»ä½•ç–‘ä¼¼é‡å¤ï¼Œç«‹å³æ”¾å¼ƒè¯¥é—®é¢˜ï¼Œç”Ÿæˆå®Œå…¨ä¸åŒæ–¹å‘çš„é—®é¢˜
- å½“æ— æ³•ç¡®å®šæ–°é—®é¢˜æ˜¯å¦é‡å¤æ—¶ï¼Œå®å¯é€‰æ‹©å…¶ä»–ä¿¡æ¯ç¼ºå£ï¼Œç»ä¸å†’é™©ç”Ÿæˆ

âŒ é‡å¤ç¤ºä¾‹ï¼ˆç»å¯¹ç¦æ­¢ï¼‰ï¼š
```
å·²é—®ï¼š"ç–¼ç—›ä¼šæ‰©æ•£å—ï¼Ÿ"
ç¦æ­¢ï¼š"æœ‰æ²¡æœ‰æ”¾å°„åˆ°å…¶ä»–éƒ¨ä½ï¼Ÿ"  # è¯­ä¹‰å®Œå…¨ç›¸åŒ
ç¦æ­¢ï¼š"ç–¼ç—›èŒƒå›´æœ‰å˜åŒ–å—ï¼Ÿ"      # æ„å›¾ç›¸åŒ

å·²é—®ï¼š"ä»€ä¹ˆå› ç´ ä¼šåŠ é‡ç–¼ç—›ï¼Ÿ"
ç¦æ­¢ï¼š"æœ‰ä»€ä¹ˆè¯±å› å—ï¼Ÿ"          # è¯¢é—®ç›¸åŒçš„å› ç´ 
ç¦æ­¢ï¼š"åšä»€ä¹ˆåŠ¨ä½œä¼šæ›´ç—›ï¼Ÿ"      # ä»ç„¶æ˜¯åŠ é‡å› ç´ 

å·²é—®ï¼š"ç–¼ç—›ç¨‹åº¦å¦‚ä½•ï¼Ÿ"
ç¦æ­¢ï¼š"èƒ½æ‰“å‡ åˆ†å—ï¼Ÿ"            # éƒ½æ˜¯é‡åŒ–ç–¼ç—›
ç¦æ­¢ï¼š"å¾ˆç—›å—ï¼Ÿ"                # ä»ç„¶é—®ç¨‹åº¦
```

âœ… æ­£ç¡®åšæ³•ï¼ˆæ·±å…¥è¿½é—®ï¼‰ï¼š
```
å·²é—®ï¼š"ç–¼ç—›ä¼šæ‰©æ•£å—ï¼Ÿ" æ‚£è€…ç­”ï¼š"ä¼š"
å…è®¸ï¼š"å…·ä½“æ‰©æ•£åˆ°å“ªäº›éƒ¨ä½ï¼Ÿå·¦è‚©ï¼Ÿå³è‚©ï¼Ÿè¿˜æ˜¯èƒŒéƒ¨ï¼Ÿ"  # åŸºäºç­”æ¡ˆæ·±å…¥ç»†èŠ‚

å·²é—®ï¼š"ä»€ä¹ˆå› ç´ ä¼šåŠ é‡ï¼Ÿ" æ‚£è€…ç­”ï¼š"åƒé¥­å"
å…è®¸ï¼š"æ˜¯åƒå®Œé¥­ç«‹å³åŠ é‡ï¼Œè¿˜æ˜¯è¿‡ä¸€æ®µæ—¶é—´ï¼Ÿå¤§æ¦‚å¤šä¹…ï¼Ÿ"  # åŸºäºç­”æ¡ˆç»†åŒ–æ—¶é—´

å·²é—®ï¼š"ç–¼ç—›ç¨‹åº¦å¦‚ä½•ï¼Ÿ" æ‚£è€…ç­”ï¼š"å¾ˆç—›ï¼Œ8åˆ†"
å…è®¸ï¼š"è¿™8åˆ†çš„ç–¼ç—›ä¼šå½±å“æ‚¨çš„æ—¥å¸¸æ´»åŠ¨å—ï¼Ÿæ¯”å¦‚ç¡çœ ã€å·¥ä½œï¼Ÿ"  # è½¬å‘åŠŸèƒ½å½±å“
```

ğŸ’¡ **é˜²é‡å¤ç­–ç•¥**ï¼š
- ä¼˜å…ˆè¯¢é—®ä¸åŒç»´åº¦çš„ä¿¡æ¯ï¼ˆç—‡çŠ¶â†’å±é™©ä¿¡å·â†’ç—…å²â†’æš´éœ²å²ï¼‰
- å½“æŸä¸ªç»´åº¦å·²å……åˆ†è¯¢é—®æ—¶ï¼Œç«‹å³è½¬å‘å…¶ä»–ç»´åº¦
- ä½¿ç”¨ã€å·²æ”¶é›†çš„ä¿¡æ¯ã€‘åˆ¤æ–­å“ªäº›æ–¹é¢ä»ç„¶ç©ºç™½

ã€é—®è¯Šç­–ç•¥ - é€æ­¥æ·±å…¥åŸåˆ™ã€‘

ğŸ”° **ç¬¬ä¸€é˜¶æ®µï¼šå¼€æ”¾å¼é—®è¯Š**ï¼ˆç¬¬1-2ä¸ªé—®é¢˜ï¼‰
   - **å¦‚æœæ˜¯é¦–æ¬¡é—®è¯Š**ï¼šå¿…é¡»ä½¿ç”¨å¼€æ”¾å¼é—®é¢˜
     * "æ‚¨å¥½ï¼Œå“ªé‡Œä¸èˆ’æœï¼Ÿ" æˆ– "ä»Šå¤©æ¥çœ‹ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
     * è®©æ‚£è€…è‡ªå·±æè¿°ï¼Œä¸è¦å‡è®¾æ‚£è€…çš„ç—‡çŠ¶
   - **é¿å…**ï¼šç›´æ¥é—®å¾ˆå…·ä½“çš„é—®é¢˜ã€ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ã€ä¸€æ¬¡é—®å¤šä¸ªé—®é¢˜
   - **ç›®çš„**ï¼šäº†è§£æ‚£è€…çš„ä¸»è¦ç—‡çŠ¶å’Œä¸»è¯‰

1ï¸âƒ£ **ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¿¡æ¯æ”¶é›†**ï¼ˆç¬¬3-5ä¸ªé—®é¢˜ï¼‰
   - **åŸºäºæ‚£è€…çš„åˆæ­¥æè¿°**ï¼Œè¿½é—®å…³é”®ç»†èŠ‚ï¼š
     * ç—‡çŠ¶ç‰¹ç‚¹ï¼šæ€§è´¨ã€éƒ¨ä½ã€ç¨‹åº¦ï¼ˆç”¨æ‚£è€…èƒ½ç†è§£çš„æ–¹å¼é—®ï¼Œå¦‚"æœ‰å¤šç—›ï¼Ÿèƒ½ç»™ä¸ªåˆ†æ•°å—ï¼Ÿ1-10åˆ†"ï¼‰
     * æ—¶é—´ä¿¡æ¯ï¼š"ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼ŸæŒç»­å¤šä¹…äº†ï¼Ÿ"ï¼ˆé¿å…è¯´"ç—…ç¨‹"è¿™ç§ä¸“ä¸šè¯ï¼‰
     * ä¼´éšç—‡çŠ¶ï¼š"é™¤äº†XXï¼Œè¿˜æœ‰å“ªé‡Œä¸èˆ’æœå—ï¼Ÿ"ï¼ˆåŸºäºæ‚£è€…å·²è¯´çš„ç—‡çŠ¶ï¼‰
   - **é—®é¢˜è¦æ±‚**ï¼šå£è¯­åŒ–ã€å…·ä½“ã€ä¸€æ¬¡ä¸€ä¸ªé—®é¢˜

2ï¸âƒ£ **å±é™©ä¿¡å·**ï¼ˆæ’é™¤æ€¥å±é‡ç—‡ï¼‰
   - çº¢æ——å¾è±¡ï¼šçªå‘å‰§çƒˆã€è¿›è¡Œæ€§åŠ é‡ã€æ„è¯†æ”¹å˜ã€ç”Ÿå‘½ä½“å¾å¼‚å¸¸
   - éœ€è¦ç«‹å³å¤„ç†çš„æƒ…å†µ
   - **ä¼˜å…ˆç­›æŸ¥**ï¼šå‘çƒ­ã€ä½“é‡ä¸‹é™ã€å¤œé—´ç›—æ±—ã€å‘¼å¸å›°éš¾ã€æ„è¯†éšœç¢

3ï¸âƒ£ **æ·±åº¦è¿½é—®**ï¼ˆæ·±å…¥æŒ–æ˜å…³é”®ç»†èŠ‚ï¼‰
   - å¯¹ä¸»è¦ç—‡çŠ¶è¿›è¡ŒSOCRATESåˆ†æï¼š
     * Site(éƒ¨ä½)ï¼šå…·ä½“ä½ç½®ï¼Œæ˜¯å¦æ”¾å°„
     * Onset(èµ·ç—…)ï¼šæ€¥æ€§/æ…¢æ€§ï¼Œè¯±å› 
     * Character(æ€§è´¨)ï¼šæè¿°æ€§è´¨ï¼ˆåˆºç—›/é’ç—›/èƒ€ç—›/ç»ç—›ï¼‰
     * Radiation(æ”¾å°„)ï¼šæ˜¯å¦æ‰©æ•£
     * Associated(ä¼´éš)ï¼šç›¸å…³ç—‡çŠ¶
     * Timing(æ—¶é—´)ï¼šæŒç»­/é—´æ­‡ï¼Œæ˜¼å¤œèŠ‚å¾‹
     * Exacerbating/Relieving(åŠ é‡/ç¼“è§£)ï¼šä»€ä¹ˆå› ç´ å½±å“
     * Severity(ä¸¥é‡åº¦)ï¼šé‡åŒ–è¯„åˆ†
   - å¯¹å¼‚å¸¸ç—‡çŠ¶è¿½é—®åˆ°å…·ä½“ç»†èŠ‚ï¼ˆä¸æ»¡è¶³äºæ¨¡ç³Šå›ç­”ï¼‰

4ï¸âƒ£ **é‰´åˆ«è¯Šæ–­**ï¼ˆç¼©å°è¯Šæ–­èŒƒå›´ï¼‰
   - åŠ é‡/ç¼“è§£å› ç´ ï¼ˆé¥®é£Ÿã€ä½“ä½ã€æ´»åŠ¨ã€æƒ…ç»ªï¼‰
   - æ—¢å¾€ç±»ä¼¼å‘ä½œï¼ˆé¢‘ç‡ã€æ²»ç–—å²ã€æ•ˆæœï¼‰
   - ç›¸å…³ç–¾ç—…å²ï¼ˆç³»ç»Ÿç–¾ç—…ã€æ‰‹æœ¯å²ï¼‰
   - **å…³é”®é‰´åˆ«ç‚¹**ï¼šæ ¹æ®åˆæ­¥æ€€ç–‘çš„è¯Šæ–­ï¼Œè¯¢é—®åŒºåˆ†æ€§ç‰¹å¾

5ï¸âƒ£ **ç—…å²è¡¥å……**ï¼ˆå®Œå–„è¯Šæ–­ä¾æ®ï¼‰
   - æ—¢å¾€ç—…å²ã€ç”¨è¯å²ï¼ˆæ…¢æ€§ç—…ã€é•¿æœŸç”¨è¯ï¼‰
   - å®¶æ—å²ï¼ˆé—ä¼ æ€§ç–¾ç—…ï¼‰
   - **æš´éœ²å²ç­›æŸ¥**ï¼ˆé‡è¦ï¼å¸¸è¢«å¿½è§†çš„è¯Šæ–­çº¿ç´¢ï¼‰ï¼š
     * å¸çƒŸå²ï¼ˆé¦™çƒŸ/ç”µå­çƒŸï¼Œæ¯å¤©æ”¯æ•°ï¼Œå¸çƒŸå¹´æ•°ï¼‰
     * é¥®é…’å²ï¼ˆç§ç±»ã€é¢‘ç‡ã€é¥®é…’å¹´æ•°ï¼‰
     * èŒä¸šæš´éœ²ï¼ˆç²‰å°˜ã€åŒ–å­¦å“ã€è¾å°„ç­‰ï¼‰
     * ç¯å¢ƒæ¥è§¦ï¼ˆæ–°è£…ä¿®ã€å® ç‰©ã€éœ‰èŒï¼‰
     * è¯ç‰©/ä¿å¥å“ï¼ˆæ–°ç”¨è¯ç‰©ã€ä¸­è‰è¯ã€è¡¥å……å‰‚ï¼‰
   - å…¶ä»–ç³»ç»Ÿç—‡çŠ¶ï¼ˆå…¨èº«æ€§ç–¾ç—…ç­›æŸ¥ï¼‰

ã€ä½ çš„ä»»åŠ¡ã€‘
âš ï¸ **é‡è¦åŸåˆ™**ï¼šé—®è¯Šçš„ç›®æ ‡æ˜¯è·å–è¶³å¤Ÿåšå‡ºä¸´åºŠå†³ç­–çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é—®æ»¡å›ºå®šè½®æ•°ã€‚ä¿¡æ¯è¶³å¤Ÿæ—¶åº”ä¸»åŠ¨åœæ­¢ï¼Œé¿å…è¿‡åº¦é—®è¯Šã€‚

åˆ†æå½“å‰é—®è¯Šè¿›åº¦ï¼Œå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š

ğŸ›‘ **åº”è¯¥åœæ­¢æé—®**ï¼ˆä¼˜å…ˆåˆ¤æ–­ï¼Œæ»¡è¶³ä»¥ä¸‹**å¤šä¸ª**æ¡ä»¶æ—¶æ‰åœæ­¢ï¼‰ï¼š
1. **è¯Šæ–­æ¸…æ™°åº¦**ï¼šå·²æ”¶é›†è¶³å¤Ÿä¿¡æ¯å¯ä»¥åšå‡ºåˆæ­¥è¯Šæ–­æˆ–åˆ¶å®šæ£€æŸ¥è®¡åˆ’
2. **æ ¸å¿ƒä¿¡æ¯å®Œæ•´**ï¼ˆé—®è¯Šå®Œæ•´æ€§æ£€æŸ¥ï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼‰ï¼š
   - âœ… ä¸»è¦ç—‡çŠ¶å·²é‡åŒ–ï¼ˆä¸¥é‡åº¦ç”¨1-10è¯„åˆ†ã€æŒç»­æ—¶é—´å…·ä½“åˆ°å¤©/å‘¨ï¼‰
   - âœ… å±é™©å¾è±¡å·²æ’æŸ¥ï¼ˆå‘çƒ­ã€ä½“é‡ä¸‹é™ã€æ„è¯†æ”¹å˜ã€æ€¥æ€§æ¶åŒ–ç­‰ï¼‰
   - âœ… é‰´åˆ«è¯Šæ–­å…³é”®ä¿¡æ¯å·²è·å–ï¼ˆè‡³å°‘2-3ä¸ªé‰´åˆ«ç‚¹ï¼‰
   - âœ… æ—¶é—´è½´æ¸…æ™°ï¼ˆèµ·ç—…æ—¶é—´ã€è¿›å±•è¶‹åŠ¿ï¼‰
   - âœ… åŠ é‡/ç¼“è§£å› ç´ æ˜ç¡®
3. **æ£€æŸ¥ä¼˜å…ˆ** AND **æ‚£è€…çŠ¶æ€è‰¯å¥½**ï¼šè¿›ä¸€æ­¥æ˜ç¡®éœ€è¦ä¾èµ–æ£€æŸ¥è€Œéé—®è¯Šï¼ˆå¦‚éœ€è¦å½±åƒã€åŒ–éªŒï¼‰ä¸”æ‚£è€…å¯ä»¥ç»§ç»­
4. **å·²è¾¾ä¸Šé™**ï¼šé—®è¯Šæ¬¡æ•°**å·²è¾¾åˆ°**ä¸Šé™ï¼ˆ{len(self.questions_asked)}/{self._max_questions}ï¼‰

æ³¨æ„ï¼šä»…å½“æ ¸å¿ƒä¿¡æ¯å®Œæ•´ï¼ˆç¬¬2æ¡æ‰€æœ‰å­é¡¹éƒ½æ»¡è¶³ï¼‰ä¸”æ»¡è¶³ç¬¬1ã€3æˆ–4æ¡ä¸­çš„è‡³å°‘ä¸€æ¡æ—¶ï¼Œæ‰åº”åœæ­¢ã€‚

âœ… **ç»§ç»­æé—®**ï¼ˆä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼‰ï¼š

ç¬¬1æ­¥ï¼šã€é‡å¤æ£€æŸ¥ - æœ€é«˜ä¼˜å…ˆçº§ã€‘
- ä»”ç»†é˜…è¯»ã€é—®è¯Šå†å²ã€‘ä¸­çš„æ¯ä¸€ä¸ªå·²é—®é—®é¢˜
- åœ¨ç”Ÿæˆæ–°é—®é¢˜å‰ï¼Œç¡®ä¿æ–°é—®é¢˜ä¸ä¸ä»»ä½•å·²é—®é—®é¢˜é‡å¤ï¼ˆå‚è€ƒä¸Šæ–¹ğŸš«é‡å¤é—®é¢˜æ£€æµ‹è§„åˆ™ï¼‰
- æ£€æŸ¥ç»´åº¦ï¼šè¯­ä¹‰ã€æ„å›¾ã€éƒ¨åˆ†åŒ…å«å…³ç³»
- å¦‚æœæ— æ³•ç¡®å®šæ˜¯å¦é‡å¤ï¼Œå®å¯æ¢ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æ–¹å‘

ç¬¬2æ­¥ï¼šã€è¯„ä¼°ä¿¡æ¯å®Œæ•´æ€§ã€‘
- å½“å‰å·²æ”¶é›†çš„ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿåšå‡ºä¸´åºŠå†³ç­–ï¼Ÿ
- æ ¸å¿ƒè¯Šæ–­è¦ç´ æ˜¯å¦é½å…¨ï¼Ÿ

ç¬¬3æ­¥ï¼šã€æ£€æŸ¥åœæ­¢æ¡ä»¶ã€‘
- æ˜¯å¦æ»¡è¶³ä»»ä½•ä¸€ä¸ª"åº”è¯¥åœæ­¢æé—®"çš„æ¡ä»¶ï¼Ÿ

ç¬¬4æ­¥ï¼šã€å†³å®šè¡ŒåŠ¨ã€‘
- æ»¡è¶³åœæ­¢æ¡ä»¶ â†’ è¿”å›ç©ºå­—ç¬¦ä¸² + è¯´æ˜ç†ç”±
- éœ€è¦ç»§ç»­ â†’ ç”Ÿæˆé’ˆå¯¹ä¿¡æ¯ç¼ºå£çš„é«˜è´¨é‡é—®é¢˜

**ç”Ÿæˆé—®é¢˜çš„å¼ºåˆ¶è¦æ±‚**ï¼š
1. âš ï¸ é—®é¢˜ä¸å¾—ä¸ã€é—®è¯Šå†å²ã€‘ä¸­çš„ä»»ä½•é—®é¢˜é‡å¤ï¼ˆæœ€é‡è¦ï¼ï¼‰
2. é—®é¢˜å¿…é¡»é’ˆå¯¹ã€å·²æ”¶é›†çš„ä¿¡æ¯ã€‘ä¸­æ˜æ˜¾çš„ç©ºç™½ç‚¹
3. é—®é¢˜è¦ç®€æ´ã€å£è¯­åŒ–ã€æ‚£è€…æ˜“æ‡‚
4. ä¸€æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜
5. é¿å…å¼€æ”¾å¼æ³›é—®ï¼ˆå¦‚"è¿˜æœ‰ä»€ä¹ˆ"ï¼‰

**è´¨é‡åŸåˆ™**ï¼š
- ä¸è¦ä¸ºäº†è¾¾åˆ°é—®è¯Šè½®æ•°è€Œæœºæ¢°æé—®
- ä¿¡æ¯è¶³å¤Ÿæ—¶ä¸»åŠ¨åœæ­¢
- æ¯ä¸ªé—®é¢˜éƒ½åº”è¯¥æœ‰æ˜ç¡®çš„è¯Šæ–­ä»·å€¼

**è¾“å‡ºJSONæ ¼å¼**ï¼š
{{
  "question": "é—®é¢˜å†…å®¹ï¼ˆå¦‚æœä¿¡æ¯è¶³å¤Ÿæˆ–åº”åœæ­¢åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰",
  "reason": "å†³ç­–ç†ç”±ï¼ˆè¯´æ˜ä¸ºä»€ä¹ˆé—®è¿™ä¸ªé—®é¢˜/ä¸ºä»€ä¹ˆåœæ­¢ï¼Œå¦‚æœæ˜¯æ–°é—®é¢˜éœ€ç®€è¦è¯´æ˜ä¸å·²é—®é—®é¢˜çš„åŒºåˆ«ï¼‰",
  "duplicate_check": "å·²ç¡®è®¤ä¸ä¸ä»¥ä¸‹é—®é¢˜é‡å¤ï¼š[åˆ—å‡ºæœ€ç›¸å…³çš„1-2ä¸ªå·²é—®é—®é¢˜ç¼–å·]"
}}

âš ï¸ **ç‰¹åˆ«æé†’ - é‡å¤æ£€æŸ¥æ˜¯æœ€é«˜ä¼˜å…ˆçº§**ï¼š
- åœ¨ç”Ÿæˆé—®é¢˜å‰ï¼Œå¿…é¡»é€æ¡æ£€æŸ¥ä¸Šé¢ã€Šå·²é—®è¿‡çš„æ‰€æœ‰é—®é¢˜ã€‹åˆ—è¡¨
- å¦‚æœæƒ³ç”Ÿæˆçš„é—®é¢˜å¯èƒ½ä¸ä»»ä½•ä¸€ä¸ªå·²é—®é—®é¢˜é‡å¤ï¼Œå¿…é¡»ç«‹å³æ›´æ¢æ–¹å‘
- å¦‚æœæ— æ³•æƒ³åˆ°ä¸é‡å¤çš„æ–°é—®é¢˜ï¼Œå°±è¿”å› question="" åœæ­¢é—®è¯Š
- duplicate_check å­—æ®µå¿…é¡»å¡«å†™ï¼Œè¯´æ˜ä½ æ£€æŸ¥è¿‡äº†å“ªäº›ç›¸å…³é—®é¢˜ **å¦‚æœç¡®å®éœ€è¦ç»§ç»­**ï¼š
   - ç”Ÿæˆä¸€ä¸ªç®€æ´ã€å£è¯­åŒ–çš„é—®é¢˜ï¼ˆé¿å…åŒ»å­¦æœ¯è¯­ï¼Œæ‚£è€…å®¹æ˜“ç†è§£ï¼‰
   - é—®é¢˜è¦æœ‰æ˜ç¡®çš„ä¸´åºŠç›®çš„ï¼Œèƒ½å¡«è¡¥å…³é”®ä¿¡æ¯ç¼ºå£
   - é¿å…å¼€æ”¾å¼æ³›é—®ï¼ˆå¦‚"è¿˜æœ‰ä»€ä¹ˆä¸èˆ’æœ"ï¼‰
   - ä¸€æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œä¸è¦å¤šä¸ªé—®é¢˜ç»„åˆ
   - **å¿…é¡»ç¡®ä¿æ–°é—®é¢˜ä¸å·²é—®é—®é¢˜å®Œå…¨ä¸é‡å¤**
3. **è´¨é‡ä¼˜å…ˆäºæ•°é‡**ï¼šå®å¯é—®5ä¸ªé«˜è´¨é‡é—®é¢˜å¾—åˆ°è¶³å¤Ÿä¿¡æ¯ï¼Œä¹Ÿä¸è¦æœºæ¢°åœ°é—®æ»¡10ä¸ªé—®é¢˜

ã€è‰¯å¥½é—®é¢˜ç¤ºä¾‹ - æŒ‰é—®è¯Šé˜¶æ®µåˆ†ç±»ã€‘

ğŸ”° **é¦–æ¬¡é—®è¯Šï¼ˆå¼€æ”¾å¼ï¼‰**ï¼š
  âœ… "æ‚¨å¥½ï¼Œå“ªé‡Œä¸èˆ’æœï¼Ÿ"
  âœ… "æ‚¨å¥½ï¼Œä»Šå¤©æ¥çœ‹ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
  âœ… "æ‚¨å¥½ï¼Œè·Ÿæˆ‘è¯´è¯´æ‚¨çš„æƒ…å†µå§ã€‚"
  âŒ "ç–¼ç—›æŒç»­å¤šä¹…äº†ï¼Ÿ"ï¼ˆæ‚£è€…è¿˜æ²¡è¯´ç–¼ç—›ï¼‰
  âŒ "æ‚¨çš„æ”¾å°„ç—›å¦‚ä½•ï¼Ÿ"ï¼ˆå¤ªä¸“ä¸šï¼Œæ‚£è€…ä¸æ‡‚ï¼‰

âœ… **é‡åŒ–è¿½é—®**ï¼ˆè¦ç”¨å£è¯­åŒ–æ–¹å¼ï¼‰ï¼š
  "æœ‰å¤šç—›ï¼Ÿèƒ½ç»™ä¸ªåˆ†æ•°å—ï¼Ÿ1åˆ†æ˜¯æœ€è½»ï¼Œ10åˆ†æ˜¯æœ€ç—›ã€‚"
  "ä¸€å¤©å‘ä½œå‡ æ¬¡ï¼Ÿæ¯æ¬¡å¤§æ¦‚å¤šé•¿æ—¶é—´ï¼Ÿ"
  "ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿæœ‰å¤šä¹…äº†ï¼Ÿ"
  
âœ… **æ·±åº¦æŒ–æ˜**ï¼ˆé¿å…ä¸“ä¸šæœ¯è¯­ï¼‰ï¼š
  "ç–¼èµ·æ¥æ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿæ˜¯é—·ç—›ã€åˆºç—›ã€è¿˜æ˜¯åƒé’ˆæ‰ä¸€æ ·ï¼Ÿ"
  "ç—›çš„åœ°æ–¹ä¼šè·‘åˆ°åˆ«çš„åœ°æ–¹å—ï¼Ÿæ¯”å¦‚åèƒŒæˆ–è€…è‚©è†€ï¼Ÿ"
  "ç–¼ç—›çš„ä½ç½®èƒ½æŒ‡ç»™æˆ‘çœ‹çœ‹å—ï¼Ÿ"
  
âœ… **é‰´åˆ«å…³é”®**ï¼ˆåŸºäºæ‚£è€…å·²æœ‰æè¿°ï¼‰ï¼š
  "åƒé¥­åä¼šæ›´ç—›è¿˜æ˜¯å¥½ä¸€ç‚¹ï¼Ÿ"
  "èººä¸‹æ—¶ä¼šä¸ä¼šåŠ é‡ï¼Ÿå¼¯è…°æˆ–è€…å’³å—½çš„æ—¶å€™å‘¢ï¼Ÿ"
  "ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæ›´éš¾å—ï¼Ÿ"
  
âœ… **å±é™©ç­›æŸ¥**ï¼ˆç”¨æ‚£è€…èƒ½æ‡‚çš„è¯ï¼‰ï¼š
  "æœ€è¿‘æœ‰æ²¡æœ‰å‘çƒ§ï¼Ÿ"
  "ä½“é‡æœ‰æ²¡æœ‰æ‰ï¼Ÿ"
  "æœ‰æ²¡æœ‰è§‰å¾—å¿ƒè·³å¿«ã€å–˜ä¸ä¸Šæ°”ã€æˆ–è€…æ™•å€’è¿‡ï¼Ÿ"
  
âœ… **ç—…å²å…³è”**ï¼š
  "ä»¥å‰æœ‰æ²¡æœ‰è¿™æ ·è¿‡ï¼Ÿå½“æ—¶æ€ä¹ˆå¥½çš„ï¼Ÿ"
  "æœ‰æ²¡æœ‰ä»€ä¹ˆæ…¢æ€§ç—…ï¼Ÿæ¯”å¦‚é«˜è¡€å‹ã€ç³–å°¿ç—…ï¼Ÿ"

âŒ **é¿å…çš„é—®é¢˜ç±»å‹**ï¼š
1. **é¦–æ¬¡é—®è¯Šå°±é—®å…·ä½“ç»†èŠ‚**ï¼ˆæ‚£è€…è¿˜æ²¡æè¿°ä¸»è¦ç—‡çŠ¶ï¼‰
   - âŒ "ç–¼ç—›æŒç»­å¤šä¹…äº†ï¼Ÿ" â†’ åº”å…ˆé—®"å“ªé‡Œä¸èˆ’æœï¼Ÿ"
   - âŒ "æœ‰æ”¾å°„ç—›å—ï¼Ÿ" â†’ åº”å…ˆè®©æ‚£è€…æè¿°ç—‡çŠ¶
   
2. **ä½¿ç”¨ä¸“ä¸šæœ¯è¯­**ï¼ˆæ‚£è€…å¯èƒ½ä¸ç†è§£ï¼‰
   - âŒ "è§¦ç—›æ˜æ˜¾å—ï¼Ÿ" â†’ âœ… "æˆ‘æŒ‰è¿™é‡Œä¼šç—›å—ï¼Ÿ"
   - âŒ "æœ‰å¤œé—´ç›—æ±—å—ï¼Ÿ" â†’ âœ… "æ™šä¸Šç¡è§‰ä¼šå‡ºå¾ˆå¤šæ±—å—ï¼Ÿ"
   - âŒ "æ”¾å°„æ€§ç–¼ç—›" â†’ âœ… "ç—›ä¼šæ‰©æ•£åˆ°å…¶ä»–åœ°æ–¹å—ï¼Ÿ"
   
3. **ä¸€æ¬¡é—®å¤šä¸ªé—®é¢˜**ï¼ˆæ‚£è€…éš¾ä»¥å›ç­”ï¼‰
   - âŒ "è¯·æè¿°ä¸€ä¸‹ç–¼ç—›çš„æ€§è´¨ã€éƒ¨ä½ã€æŒç»­æ—¶é—´å’ŒåŠ é‡å› ç´ ã€‚" 
   - âœ… ä¸€æ¬¡é—®ä¸€ä¸ªï¼š"æ˜¯ä»€ä¹ˆæ ·çš„ç—›ï¼Ÿé—·ç—›è¿˜æ˜¯åˆºç—›ï¼Ÿ"
   
4. **è¿‡åº¦å¼€æ”¾çš„é—®é¢˜**ï¼ˆæ— æ³•å¼•å¯¼æ‚£è€…ï¼‰
   - âŒ "æ‚¨è¿˜æœ‰ä»€ä¹ˆå…¶ä»–ç—‡çŠ¶å—ï¼Ÿ"
   - âœ… "é™¤äº†å¤´ç—›ï¼Œè‚šå­æœ‰æ²¡æœ‰ä¸èˆ’æœï¼Ÿæ¶å¿ƒæƒ³åå—ï¼Ÿ"
   
5. **å‡è®¾æ€§é—®é¢˜**ï¼ˆæ‚£è€…è¿˜æ²¡æåˆ°çš„æƒ…å†µï¼‰
   - âŒ "æ‚¨çš„èƒ¸ç—›ä¼šæ”¾å°„åˆ°å·¦è‡‚å—ï¼Ÿ"ï¼ˆæ‚£è€…å¯èƒ½åªæ˜¯å¤´ç—›ï¼‰
   - âœ… å…ˆç¡®è®¤ç—‡çŠ¶ï¼Œå†è¿½é—®ç»†èŠ‚

ğŸ’¡ **å£è¯­åŒ–åŸåˆ™**ï¼š
- ç”¨"ç—›"è€Œä¸æ˜¯"ç–¼ç—›"ã€"è§¦ç—›"
- ç”¨"æœ‰æ²¡æœ‰"è€Œä¸æ˜¯"æ˜¯å¦å­˜åœ¨"
- ç”¨"ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„"è€Œä¸æ˜¯"å‘ç—…æ—¶é—´"
- ç”¨"æ™šä¸Š"è€Œä¸æ˜¯"å¤œé—´"
- ç”¨"æ‹‰è‚šå­"è€Œä¸æ˜¯"è…¹æ³»"

ğŸ’¡ **é€æ­¥å¼•å¯¼åŸåˆ™**ï¼š
- ç¬¬1é—®ï¼šå¼€æ”¾å¼ï¼Œè®©æ‚£è€…è‡ªå·±è¯´
- ç¬¬2-3é—®ï¼šé’ˆå¯¹æ‚£è€…æåˆ°çš„ç—‡çŠ¶ï¼Œé—®æ—¶é—´ã€ç¨‹åº¦
- ç¬¬4-5é—®ï¼šè¿½é—®ä¼´éšç—‡çŠ¶ã€åŠ é‡ç¼“è§£å› ç´ 
- ç¬¬6-7é—®ï¼šå±é™©ä¿¡å·ç­›æŸ¥
- ç¬¬8-10é—®ï¼šæ—¢å¾€å²ã€æš´éœ²å²
âŒ é¿å…ï¼šä¸å·²é—®é—®é¢˜æ„æ€ç›¸åŒæˆ–é«˜åº¦ç›¸ä¼¼çš„é—®é¢˜
âŒ é¿å…ï¼š"æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ"ï¼ˆè¿‡äºå¼€æ”¾ï¼Œç¼ºä¹ç›®çš„æ€§ï¼‰
"""
        
        user_prompt = "è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œå†³å®šæ˜¯å¦ç»§ç»­é—®è¯Šã€‚å¦‚æœéœ€è¦ç»§ç»­ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜ï¼›å¦‚æœä¿¡æ¯å·²è¶³å¤Ÿï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚"
        
        # è°ƒç”¨LLMç”Ÿæˆé—®é¢˜(åªå°è¯•1æ¬¡ï¼Œå› ä¸ºpromptå·²ç»å……åˆ†å¼ºè°ƒäº†é¿å…é‡å¤)
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                fallback=lambda: {"question": "", "reason": "", "duplicate_check": ""},
                temperature=0.3
            )
            question = str(obj.get("question", "")).strip()
            reason = str(obj.get("reason", "")).strip()
            duplicate_check = str(obj.get("duplicate_check", "")).strip()
            
            # å¦‚æœä¸ºç©ºï¼Œç›´æ¥è¿”å›
            if not question:
                if reason:
                    self._logger.debug(f"  ğŸ’¡ åœæ­¢é—®è¯Š: {reason}")
                return ""
            
            # ã€æœ€åçš„å®‰å…¨ç½‘ã€‘æ£€æŸ¥æ˜¯å¦é‡å¤
            # æ³¨æ„ï¼šç”±äºpromptå·²ç»å¼ºè°ƒé¿å…é‡å¤ï¼Œè¿™é‡Œåº”è¯¥å¾ˆå°‘è§¦å‘
            if self._is_duplicate_question(question):
                self._logger.warning(
                    f"  âš ï¸  LLMç”Ÿæˆäº†é‡å¤é—®é¢˜ï¼ˆå°½ç®¡promptå·²å¼ºè°ƒé¿å…ï¼‰\n"
                    f"     ç”Ÿæˆçš„é—®é¢˜: {question}\n"
                    f"     LLMè‡ªå·±çš„æ£€æŸ¥: {duplicate_check if duplicate_check else 'æœªå¡«å†™'}\n"
                    f"     å½“å‰å·²é—®é—®é¢˜æ•°: {len(self.questions_asked)}"
                )
                self._logger.warning(f"      å·²é—®é—®é¢˜å‚è€ƒ: {self.questions_asked[-3:] if len(self.questions_asked) >= 3 else self.questions_asked}")
                self._logger.warning(f"      è·³è¿‡æœ¬è½®æé—®ï¼Œé¿å…é‡å¤")
                return ""
            
            # æ˜¾ç¤ºé—®é¢˜ç”Ÿæˆä¿¡æ¯
            if reason:
                self._logger.debug(f"  ğŸ’¡ é—®é¢˜ç›®çš„: {reason}")
            if duplicate_check:
                self._logger.debug(f"  âœ“ é‡å¤æ£€æŸ¥: {duplicate_check}")
            
            return question
                    
        except Exception as e:
            self._logger.error(f"  âŒ ç”Ÿæˆé—®é¢˜æ—¶å‡ºé”™: {e}")
            return ""
    
    def generate_question_based_on_tests(
        self,
        test_results: list[dict[str, Any]],
        chief_complaint: str,
        collected_info: dict[str, Any]
    ) -> str:
        """åŸºäºæ£€æŸ¥ç»“æœç”Ÿæˆè¿›ä¸€æ­¥é—®è¯Šé—®é¢˜
        
        Args:
            test_results: æ£€æŸ¥ç»“æœåˆ—è¡¨
            chief_complaint: ä¸»è¯‰
            collected_info: å·²æ”¶é›†çš„ä¿¡æ¯
            
        Returns:
            å•ä¸ªé—®é¢˜å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸éœ€è¦ç»§ç»­é—®åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        
        æ³¨æ„ï¼šé—®é¢˜æ•°é‡é™åˆ¶ç”±è°ƒç”¨æ–¹ï¼ˆå¦‚C11èŠ‚ç‚¹ï¼‰é€šè¿‡å…¨å±€è®¡æ•°å™¨æ§åˆ¶
        """
        
        # LLMæ¨¡å¼ï¼šæ™ºèƒ½ç”Ÿæˆé—®é¢˜
        # æå–å¼‚å¸¸ç»“æœ
        abnormal_results = [r for r in test_results if r.get("abnormal")]
        normal_results = [r for r in test_results if not r.get("abnormal")]
        
        # å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œå¯èƒ½ä¸éœ€è¦ç»§ç»­é—®
        if not abnormal_results:
            return ""
        
        # æ„å»ºå·²é—®é—®é¢˜åˆ—è¡¨
        asked_summary = "\n".join([f"Q{i+1}: {q}" for i, q in enumerate(self.questions_asked)])
        
        system_prompt = f"""ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„{self._dept_name()}åŒ»ç”Ÿï¼Œåˆšåˆšæ”¶åˆ°æ‚£è€…çš„æ£€æŸ¥æŠ¥å‘Šã€‚ä½ éœ€è¦å°†æ£€æŸ¥ç»“æœä¸ä¸´åºŠè¡¨ç°ç›¸äº’å°è¯ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ‚£è€…ä¸»è¯‰ã€‘
{chief_complaint}

ã€é—®è¯Šå·²æ”¶é›†çš„ä¿¡æ¯ã€‘
{json.dumps(collected_info, ensure_ascii=False, indent=2)}

ã€æ£€æŸ¥ç»“æœåˆ†æã€‘
ğŸ”´ å¼‚å¸¸é¡¹ç›® ({len(abnormal_results)}é¡¹)ï¼š
{json.dumps(abnormal_results, ensure_ascii=False, indent=2)}

âœ… æ­£å¸¸é¡¹ç›® ({len(normal_results)}é¡¹)ï¼š
{json.dumps([r.get('test') for r in normal_results], ensure_ascii=False)}

ã€ä¹‹å‰åŸºäºæ£€æŸ¥ç»“æœçš„æé—®ã€‘
{asked_summary if asked_summary else "ï¼ˆå°šæœªåŸºäºæ£€æŸ¥ç»“æœæé—®ï¼‰"}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ä¸´åºŠæ€ç»´æµç¨‹ã€‘

1ï¸âƒ£ **å¼‚å¸¸ç»“æœè§£è¯»**
   - è¿™ä¸ªå¼‚å¸¸æŒ‡æ ‡æç¤ºä»€ä¹ˆç—…ç†çŠ¶æ€ï¼Ÿ
   - ä¸æ‚£è€…ä¸»è¯‰æ˜¯å¦ç›¸ç¬¦ï¼Ÿ
   - æ˜¯å¦éœ€è¦è¿½é—®ç›¸å…³ç—‡çŠ¶æ¥ä½è¯ï¼Ÿ

2ï¸âƒ£ **ç—‡çŠ¶-ä½“å¾-æ£€æŸ¥ä¸‰è§’å°è¯**
   - æ£€æŸ¥å¼‚å¸¸ â†’ åº”è¯¥æœ‰å¯¹åº”çš„ä¸´åºŠè¡¨ç°
   - è¯¢é—®æ‚£è€…æ˜¯å¦æœ‰ç›¸å…³ç—‡çŠ¶ä½†ä¹‹å‰æœªæåŠ
   - è¯„ä¼°ç—‡çŠ¶çš„ä¸¥é‡ç¨‹åº¦ä¸æ£€æŸ¥ç»“æœæ˜¯å¦åŒ¹é…

3ï¸âƒ£ **ç—…å› è¿½æº¯**
   - è¿™ä¸ªå¼‚å¸¸æ˜¯æ€¥æ€§è¿˜æ˜¯æ…¢æ€§ï¼Ÿ
   - æ˜¯å¦æœ‰è¯±å‘å› ç´ æˆ–åŸºç¡€ç–¾ç—…ï¼Ÿ
   - æ—¢å¾€æ˜¯å¦æœ‰ç±»ä¼¼å¼‚å¸¸ï¼Ÿ

4ï¸âƒ£ **å¹¶å‘ç—‡ç­›æŸ¥**
   - è¿™ä¸ªå¼‚å¸¸å¯èƒ½å¯¼è‡´ä»€ä¹ˆå¹¶å‘ç—‡ï¼Ÿ
   - æ‚£è€…æ˜¯å¦å·²å‡ºç°æ—©æœŸå¾è±¡ï¼Ÿ

ã€å†³ç­–æŒ‡å—ã€‘

âœ… **éœ€è¦è¿½é—®**ï¼ˆæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶ï¼‰ï¼š
- å¼‚å¸¸ç»“æœæ˜¾è‘—ï¼Œä½†æ‚£è€…æœªä¸»åŠ¨æåŠç›¸å…³ç—‡çŠ¶
- å¼‚å¸¸ç¨‹åº¦ä¸ç—‡çŠ¶ä¸åŒ¹é…ï¼Œéœ€è¦äº†è§£è¯¦ç»†æƒ…å†µ
- æç¤ºæ½œåœ¨å¹¶å‘ç—‡ï¼Œéœ€è¦ç­›æŸ¥ç›¸å…³è¡¨ç°
- éœ€è¦æ˜ç¡®ç—…å› ã€è¯±å› æˆ–ç—…ç¨‹è¿›å±•
- ä¸ä¸»è¯‰ç›¸å…³ï¼Œæœ‰åŠ©äºè¯Šæ–­æˆ–è¯„ä¼°ä¸¥é‡ç¨‹åº¦

ğŸ›‘ **æ— éœ€è¿½é—®**ï¼ˆæ»¡è¶³ä»¥ä¸‹æƒ…å†µï¼‰ï¼š
- å¼‚å¸¸è½»å¾®ï¼Œä¸´åºŠæ„ä¹‰ä¸å¤§
- ä¸å½“å‰ä¸»è¯‰æ— å…³çš„å¶ç„¶å‘ç°
- æ‚£è€…å·²å……åˆ†æè¿°è¿‡ç›¸å…³ç—‡çŠ¶
- è¯¥ä¿¡æ¯å¯¹å½“å‰è¯Šç–—å†³ç­–æ— å®è´¨å½±å“
- éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥è€Œéé—®è¯Šæ¥æ˜ç¡®

ã€è¾“å‡ºè¦æ±‚ã€‘
ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ»¡è¶³ï¼š
1. **ç›®çš„æ˜ç¡®**ï¼šç›´æ¥é’ˆå¯¹æ£€æŸ¥å¼‚å¸¸ï¼Œè¯¢é—®ç›¸å…³ç—‡çŠ¶æˆ–ç—…å²
2. **ç®€æ´æ˜“æ‡‚**ï¼šç”¨æ‚£è€…èƒ½ç†è§£çš„è¯­è¨€ï¼Œé¿å…ä¸“ä¸šæœ¯è¯­
3. **ä¸´åºŠä»·å€¼**ï¼šå¯¹è¯Šæ–­ã€æ²»ç–—æˆ–é¢„åè¯„ä¼°æœ‰å®é™…å¸®åŠ©
4. **ä¸é‡å¤**ï¼šä¸ä¹‹å‰é—®é¢˜ä¸é‡å¤

å¦‚æœä¸éœ€è¦è¿½é—®ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² ""

ã€ä¼˜ç§€æé—®ç¤ºä¾‹ã€‘

åœºæ™¯1ï¼šè¡€çº¢è›‹ç™½ä½ï¼ˆè´«è¡€ï¼‰
âœ… "æœ€è¿‘æœ‰æ²¡æœ‰æ„Ÿè§‰ç‰¹åˆ«å®¹æ˜“ç´¯ï¼Ÿèµ°è·¯æˆ–çˆ¬æ¥¼æ¢¯ä¼šæ°”å–˜å—ï¼Ÿ"
âœ… "å¤§ä¾¿é¢œè‰²æ­£å¸¸å—ï¼Ÿæœ‰æ²¡æœ‰å‘é»‘çš„æƒ…å†µï¼Ÿ"

åœºæ™¯2ï¼šè‚åŠŸèƒ½å¼‚å¸¸
âœ… "æœ€è¿‘æœ‰æ²¡æœ‰å‘ç°çœ¼ç›æˆ–çš®è‚¤å‘é»„ï¼Ÿ"
âœ… "è‚šå­æœ‰æ²¡æœ‰èƒ€ï¼Œèƒ½ä¸èƒ½åƒå¾—ä¸‹é¥­ï¼Ÿ"

åœºæ™¯3ï¼šç‚ç—‡æŒ‡æ ‡é«˜
âœ… "æœ‰æ²¡æœ‰å‘çƒ§ï¼Ÿä½“æ¸©æœ€é«˜å¤šå°‘åº¦ï¼Ÿ"
âœ… "èº«ä½“å“ªä¸ªéƒ¨ä½ç‰¹åˆ«ä¸èˆ’æœæˆ–è€…è‚¿äº†ï¼Ÿ"

âŒ é¿å…æ³›æ³›çš„é—®é¢˜ï¼š"æ£€æŸ¥ç»“æœæœ‰äº›å¼‚å¸¸ï¼Œæ‚¨æœ€è¿‘èº«ä½“è¿˜æœ‰å…¶ä»–ä¸é€‚å—ï¼Ÿ"
"""
        
        user_prompt = 'è¯·ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œè¾“å‡ºJSONæ ¼å¼ï¼š{"question": "é—®é¢˜å†…å®¹"} æˆ– {"question": ""} è¡¨ç¤ºæ— éœ€ç»§ç»­æé—®'
        
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                fallback=lambda: {"question": ""},
                temperature=0.3
            )
            return str(obj.get("question", ""))
        except Exception:
            # å‘ç”Ÿå¼‚å¸¸æ—¶è¿”å›è§„åˆ™é—®é¢˜
            abnormal = [r for r in test_results if r.get("abnormal")]
            if abnormal:
                return "çœ‹åˆ°æ£€æŸ¥ç»“æœæœ‰äº›å¼‚å¸¸ï¼Œæ‚¨æœ€è¿‘èº«ä½“è¿˜æœ‰å…¶ä»–ä¸é€‚å—ï¼Ÿ"
            return ""
    
    def generate_clarification_question(
        self,
        diagnosis_info: dict[str, Any],
        collected_info: dict[str, Any]
    ) -> str:
        """åŸºäºè¯Šæ–­ä¸ç¡®å®šæ€§ç”Ÿæˆæ¾„æ¸…é—®é¢˜
        
        Args:
            diagnosis_info: è¯Šæ–­ä¿¡æ¯ï¼ŒåŒ…æ‹¬current_diagnosis, uncertainty_reason, test_results, rule_outç­‰
            collected_info: å·²æ”¶é›†çš„ä¿¡æ¯
            
        Returns:
            å•ä¸ªé—®é¢˜å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸éœ€è¦ç»§ç»­é—®åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
        """
        
        if not self._llm:
            return ""
        
        # æ„å»ºå·²é—®é—®é¢˜åˆ—è¡¨
        asked_summary = "\n".join([f"Q{i+1}: {q}" for i, q in enumerate(self.questions_asked)])
        
        current_diagnosis = diagnosis_info.get("current_diagnosis", "æœªæ˜ç¡®")
        uncertainty_reason = diagnosis_info.get("uncertainty_reason", "")
        test_results_summary = diagnosis_info.get("test_results", [])
        rule_out_list = diagnosis_info.get("rule_out", [])
        
        system_prompt = f"""ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„{self._dept_name()}åŒ»ç”Ÿï¼Œå½“å‰é¢ä¸´è¯Šæ–­ä¸ç¡®å®šçš„æƒ…å†µï¼Œéœ€è¦é€šè¿‡è¡¥å……é—®è¯Šæ¥æ˜ç¡®è¯Šæ–­ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å½“å‰è¯Šæ–­ã€‘
{current_diagnosis}

ã€ä¸ç¡®å®šåŸå› ã€‘
{uncertainty_reason}

ã€æ£€æŸ¥ç»“æœæ‘˜è¦ã€‘
{json.dumps(test_results_summary, ensure_ascii=False, indent=2)}

ã€éœ€è¦é‰´åˆ«çš„è¯Šæ–­ã€‘
{json.dumps(rule_out_list, ensure_ascii=False, indent=2)}

ã€å·²æ”¶é›†çš„ä¿¡æ¯ã€‘
{json.dumps(collected_info, ensure_ascii=False, indent=2)}

ã€ä¹‹å‰çš„æé—®ã€‘
{asked_summary if asked_summary else "ï¼ˆå°šæœªæé—®ï¼‰"}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ä¸´åºŠæ€ç»´æµç¨‹ã€‘

1ï¸âƒ£ **è¯Šæ–­ä¸ç¡®å®šæ€§åˆ†æ**
   - ä¸ºä»€ä¹ˆå½“å‰è¯Šæ–­ä¸ç¡®å®šï¼Ÿç¼ºå°‘å“ªäº›å…³é”®ä¿¡æ¯ï¼Ÿ
   - æœ‰å“ªäº›é‰´åˆ«è¯Šæ–­éœ€è¦æ’é™¤ï¼Ÿ
   - å“ªäº›ç—‡çŠ¶ã€ä½“å¾æˆ–ç—…å²èƒ½å¤Ÿå¸®åŠ©é‰´åˆ«ï¼Ÿ

2ï¸âƒ£ **é‰´åˆ«è¯Šæ–­çš„å…³é”®ç‚¹**
   - Aè¯Šæ–­å’ŒBè¯Šæ–­çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
   - æœ‰å“ªäº›ç‰¹å¾æ€§ç—‡çŠ¶æˆ–ç—…å²å¯ä»¥å¸®åŠ©é‰´åˆ«ï¼Ÿ
   - æ‚£è€…æ˜¯å¦æœ‰æœªæåŠä½†å¯¹è¯Šæ–­æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Ÿ

3ï¸âƒ£ **ç—…ç¨‹å’Œä¼´éšç—‡çŠ¶**
   - ç—‡çŠ¶çš„æ—¶é—´é¡ºåºå’Œæ¼”å˜è¿‡ç¨‹
   - æ˜¯å¦æœ‰ä¼´éšç—‡çŠ¶æˆ–è¯±å‘å› ç´ 
   - æ—¢å¾€ç±»ä¼¼å‘ä½œçš„æƒ…å†µ

4ï¸âƒ£ **æ²»ç–—å’Œç”¨è¯å²**
   - ä¹‹å‰æ˜¯å¦æ¥å—è¿‡æ²»ç–—ï¼Ÿæ•ˆæœå¦‚ä½•ï¼Ÿ
   - æ˜¯å¦æœç”¨è¿‡ç›¸å…³è¯ç‰©ï¼Ÿ
   - æœ‰æ— è¿‡æ•å²æˆ–ç¦å¿Œç—‡ï¼Ÿ

ã€å†³ç­–æŒ‡å—ã€‘

âœ… **éœ€è¦è¿½é—®**ï¼ˆæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶ï¼‰ï¼š
- æœ‰åŠ©äºåœ¨å¤šä¸ªé‰´åˆ«è¯Šæ–­ä¸­æ˜ç¡®ä¸»è¦è¯Šæ–­
- èƒ½å¤Ÿæ’é™¤é‡è¦çš„é‰´åˆ«è¯Šæ–­
- è¡¥å……å…³é”®çš„ç—…å²ã€ç—‡çŠ¶ç»†èŠ‚æˆ–ä¼´éšç—‡çŠ¶
- äº†è§£æ²»ç–—å²æˆ–ç”¨è¯å²ï¼Œæœ‰åŠ©äºè¯„ä¼°ç—…æƒ…
- ä¸å½“å‰è¯Šæ–­çš„ä¸ç¡®å®šæ€§ç›´æ¥ç›¸å…³

ğŸ›‘ **æ— éœ€è¿½é—®**ï¼ˆæ»¡è¶³ä»¥ä¸‹æƒ…å†µï¼‰ï¼š
- å·²æœ‰è¶³å¤Ÿä¿¡æ¯æ”¯æŒå½“å‰è¯Šæ–­
- é‰´åˆ«è¯Šæ–­å·²åŸºæœ¬æ’é™¤
- è¯¥ä¿¡æ¯å¯¹è¯Šæ–­å†³ç­–æ— å®è´¨å½±å“
- éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥è€Œéé—®è¯Šæ¥æ˜ç¡®
- ä¸ä¹‹å‰é—®é¢˜é‡å¤

ã€è¾“å‡ºè¦æ±‚ã€‘
ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œæ»¡è¶³ï¼š
1. **é’ˆå¯¹æ€§å¼º**ï¼šç›´æ¥é’ˆå¯¹è¯Šæ–­ä¸ç¡®å®šæ€§æˆ–é‰´åˆ«è¯Šæ–­
2. **ç®€æ´æ˜“æ‡‚**ï¼šç”¨æ‚£è€…èƒ½ç†è§£çš„è¯­è¨€
3. **ä¸´åºŠä»·å€¼**ï¼šå¯¹æ˜ç¡®è¯Šæ–­æœ‰ç›´æ¥å¸®åŠ©
4. **ä¸é‡å¤**ï¼šä¸ä¹‹å‰é—®é¢˜ä¸é‡å¤

å¦‚æœä¸éœ€è¦è¿½é—®ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² ""

ã€ä¼˜ç§€æé—®ç¤ºä¾‹ã€‘

åœºæ™¯1ï¼šé‰´åˆ«ç´§å¼ æ€§å¤´ç—› vs åå¤´ç—›
âœ… "å¤´ç—›çš„æ—¶å€™ï¼Œæ˜¯æ•´ä¸ªå¤´éƒ½ç–¼ï¼Œè¿˜æ˜¯ä¸€ä¾§ç–¼å¾—æ›´æ˜æ˜¾ï¼Ÿ"
âœ… "å¤´ç–¼çš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰æ¶å¿ƒæƒ³åçš„æ„Ÿè§‰ï¼Ÿ"
âœ… "å…‰çº¿æˆ–å£°éŸ³ä¼šè®©å¤´ç–¼åŠ é‡å—ï¼Ÿ"

åœºæ™¯2ï¼šé‰´åˆ«ç—…æ¯’æ€§æ„ŸæŸ“ vs ç»†èŒæ€§æ„ŸæŸ“
âœ… "å’³å‡ºæ¥çš„ç—°æ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Ÿæ˜¯æ¸…çš„è¿˜æ˜¯é»„ç»¿è‰²çš„ï¼Ÿ"
âœ… "é¼»æ¶•æ˜¯æ¸…æ°´æ ·çš„è¿˜æ˜¯æµ“ç¨ çš„ï¼Ÿ"

åœºæ™¯3ï¼šé‰´åˆ«åŠŸèƒ½æ€§ vs å™¨è´¨æ€§ç–¾ç—…
âœ… "è¿™ä¸ªç—‡çŠ¶æ˜¯æœ€è¿‘æ‰å‡ºç°çš„ï¼Œè¿˜æ˜¯å¾ˆå¤šå¹´äº†ï¼Ÿ"
âœ… "ä¹‹å‰åšè¿‡ä»€ä¹ˆæ£€æŸ¥å—ï¼Ÿç»“æœæ€ä¹ˆæ ·ï¼Ÿ"
âœ… "æœ‰æ²¡æœ‰æ²»ç–—è¿‡ï¼Ÿç”¨äº†ä»€ä¹ˆè¯ï¼Ÿæ•ˆæœå¦‚ä½•ï¼Ÿ"

âŒ é¿å…æ³›æ³›çš„é—®é¢˜ï¼š"æ‚¨è¿˜æœ‰å…¶ä»–ç—‡çŠ¶å—ï¼Ÿ"
"""
        
        user_prompt = 'è¯·ç”Ÿæˆä¸€ä¸ªé—®é¢˜ï¼Œè¾“å‡ºJSONæ ¼å¼ï¼š{"question": "é—®é¢˜å†…å®¹"} æˆ– {"question": ""} è¡¨ç¤ºæ— éœ€ç»§ç»­æé—®'
        
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                fallback=lambda: {"question": ""},
                temperature=0.3
            )
            question = str(obj.get("question", ""))
            
            # æ£€æŸ¥æ˜¯å¦ä¸ä¹‹å‰çš„é—®é¢˜é‡å¤
            if question and self._is_duplicate_question(question):
                return ""
            
            return question
        except Exception:
            return ""
    
    def _is_duplicate_question(self, new_question: str) -> bool:
        """æ£€æµ‹æ–°é—®é¢˜æ˜¯å¦ä¸å·²é—®é—®é¢˜é‡å¤
        
        Args:
            new_question: æ–°ç”Ÿæˆçš„é—®é¢˜
            
        Returns:
            Trueè¡¨ç¤ºé‡å¤ï¼ŒFalseè¡¨ç¤ºä¸é‡å¤
        """
        if not new_question or not self.questions_asked:
            return False
        
        new_q = new_question.lower().strip("ï¼Ÿ?ã€‚. ")
        
        for asked_q in self.questions_asked:
            asked_q_normalized = asked_q.lower().strip("ï¼Ÿ?ã€‚. ")
            
            # 1. å®Œå…¨ç›¸åŒ
            if new_q == asked_q_normalized:
                return True
            
            # 2. é«˜åº¦ç›¸ä¼¼ï¼ˆå…³é”®è¯é‡å åº¦æ£€æµ‹ï¼‰
            # æå–æ ¸å¿ƒå…³é”®è¯ï¼ˆå»é™¤å¸¸è§åŠ©è¯å’Œæ ‡ç‚¹ï¼‰
            stop_words = {"çš„", "äº†", "å—", "å‘¢", "å•Š", "æ‚¨", "ä½ ", "æœ‰æ²¡æœ‰", "æ˜¯ä¸æ˜¯", "è¿˜", "ä¹Ÿ", "éƒ½", "å’Œ", "æˆ–è€…", "ä»¥åŠ"}
            
            def extract_keywords(text: str) -> set:
                """æå–å…³é”®è¯"""
                import re
                # ç§»é™¤æ ‡ç‚¹å’Œç©ºæ ¼
                text = re.sub(r'[^\w]', ' ', text)
                words = text.split()
                # è¿‡æ»¤åœç”¨è¯å’Œå•å­—è¯ï¼ˆé™¤äº†ä¸€äº›é‡è¦çš„å•å­—ï¼‰
                important_single = {"ç—›", "ç–¼", "éº»", "çº¢", "è‚¿", "çƒ­", "å†·", "æ™•", "å", "æ³»"}
                keywords = {w for w in words if w not in stop_words and (len(w) > 1 or w in important_single)}
                return keywords
            
            new_keywords = extract_keywords(new_q)
            asked_keywords = extract_keywords(asked_q_normalized)
            
            if not new_keywords or not asked_keywords:
                continue
            
            # è®¡ç®—å…³é”®è¯é‡å åº¦
            overlap = new_keywords & asked_keywords
            overlap_ratio = len(overlap) / min(len(new_keywords), len(asked_keywords))
            
            # å¦‚æœé‡å åº¦è¶…è¿‡70%ï¼Œè®¤ä¸ºæ˜¯é‡å¤é—®é¢˜
            if overlap_ratio > 0.7:
                return True
        
        return False
    
    def process_patient_answer(self, question: str, answer: str) -> None:
        """å¤„ç†æ‚£è€…çš„å›ç­”ï¼Œæ›´æ–°æ”¶é›†çš„ä¿¡æ¯"""
        self.questions_asked.append(question)
        
        # å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ä¸”è¯¢é—®ä¸»è¯‰ï¼Œæå–ä¸»è¯‰
        if len(self.questions_asked) == 1 and any(keyword in question for keyword in ["å“ªé‡Œä¸èˆ’æœ", "ä»€ä¹ˆç—‡çŠ¶", "æ€ä¹ˆäº†", "ä¸»è¯‰"]):
            # ç®€å•æå–ï¼šå°†ç¬¬ä¸€ä¸ªå›ç­”ä½œä¸ºåˆæ­¥ä¸»è¯‰
            self.collected_info["chief_complaint"] = answer[:100]  # é™åˆ¶é•¿åº¦
        
        # å¦‚æœæœ‰LLMï¼Œä½¿ç”¨LLMæå–ç»“æ„åŒ–ä¿¡æ¯
        if self._llm is not None:
            try:
                system_prompt = f"""ä½ æ˜¯{self._dept_name()}åŒ»ç”Ÿï¼Œæ­£åœ¨åˆ†ææ‚£è€…å›ç­”å¹¶æå–å…³é”®ä¿¡æ¯ã€‚

ã€é—®é¢˜ã€‘
{question}

ã€æ‚£è€…å›ç­”ã€‘
{answer}

ã€ä»»åŠ¡ã€‘
ä»å›ç­”ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ï¼Œå¦‚ï¼š
- duration: æŒç»­æ—¶é—´
- severity: ä¸¥é‡ç¨‹åº¦
- frequency: é¢‘ç‡
- aggravating_factors: åŠ é‡å› ç´ 
- relieving_factors: ç¼“è§£å› ç´ 
- associated_symptoms: ä¼´éšç—‡çŠ¶
- medical_history: ç›¸å…³ç—…å²
- other_info: å…¶ä»–ä¿¡æ¯

åªæå–å›ç­”ä¸­æ˜ç¡®åŒ…å«çš„ä¿¡æ¯ï¼Œä¸è¦æ¨æµ‹ã€‚
"""
                
                user_prompt = 'è¾“å‡ºJSONæ ¼å¼ï¼š{"extracted_info": {"duration": "...", "severity": "...", ...}}'
                
                obj, _, _ = self._llm.generate_json(
                    system_prompt=system_prompt,
                    user_prompt=user_prompt,
                    fallback=lambda: {"extracted_info": {}},
                    temperature=0.1
                )
                
                extracted = obj.get("extracted_info", {})
                # åˆå¹¶åˆ°history
                for key, value in extracted.items():
                    if value and value != "N/A" and value != "ä¸è¯¦":
                        if key in ["associated_symptoms", "aggravating_factors", "relieving_factors"]:
                            # åˆ—è¡¨ç±»å‹ï¼Œè¿½åŠ 
                            if key not in self.collected_info["history"]:
                                self.collected_info["history"][key] = []
                            if isinstance(value, list):
                                self.collected_info["history"][key].extend(value)
                            else:
                                self.collected_info["history"][key].append(value)
                        else:
                            # å•å€¼ç±»å‹ï¼Œè¦†ç›–
                            self.collected_info["history"][key] = value
            except Exception:
                pass
    
    def assess_interview_quality(self) -> dict[str, Any]:
        """è¯„ä¼°å½“å‰é—®è¯Šè´¨é‡ï¼Œæä¾›æ”¹è¿›å»ºè®®
        
        Returns:
            dict: åŒ…å«è´¨é‡è¯„åˆ†å’Œå»ºè®®
        """
        quality_report = {
            "completeness_score": 0,  # 0-100
            "depth_score": 0,  # 0-100
            "efficiency_score": 0,  # 0-100
            "overall_score": 0,  # 0-100
            "missing_areas": [],  # ç¼ºå¤±çš„å…³é”®ä¿¡æ¯
            "suggestions": [],  # æ”¹è¿›å»ºè®®
            "warning": None  # è­¦å‘Šä¿¡æ¯
        }
        
        # 1. å®Œæ•´æ€§è¯„ä¼°ï¼ˆ40åˆ†ï¼‰
        completeness = 0
        
        # æ£€æŸ¥ä¸»è¯‰ï¼ˆå¿…é¡»æœ‰ï¼Œ10åˆ†ï¼‰
        if self.collected_info.get("chief_complaint"):
            completeness += 10
        
        # æ£€æŸ¥æŒç»­æ—¶é—´ï¼ˆå¿…é¡»æœ‰ï¼Œ15åˆ†ï¼‰
        history = self.collected_info.get("history", {})
        if "duration" in history and history["duration"]:
            completeness += 15
        else:
            quality_report["missing_areas"].append("ç—‡çŠ¶æŒç»­æ—¶é—´")
        
        # æ£€æŸ¥ä¸¥é‡ç¨‹åº¦ï¼ˆå¿…é¡»æœ‰ï¼Œ15åˆ†ï¼‰
        if "severity" in history and history["severity"]:
            completeness += 15
        else:
            quality_report["missing_areas"].append("ç—‡çŠ¶ä¸¥é‡ç¨‹åº¦")
        
        # æ£€æŸ¥ä¼´éšç—‡çŠ¶ï¼ˆ10åˆ†ï¼‰
        if self.collected_info.get("symptoms") or history.get("associated_symptoms"):
            completeness += 10
        
        quality_report["completeness_score"] = min(100, completeness * 2)
        
        # 2. æ·±åº¦è¯„ä¼°ï¼ˆ30åˆ†ï¼‰
        depth = 0
        
        # æ£€æŸ¥ç—‡çŠ¶é‡åŒ–
        quantified_keywords = ["å‡ åˆ†", "1-10", "è¯„åˆ†", "å¤šå°‘", "é¢‘ç‡", "æ¬¡æ•°"]
        quantified_questions = sum(1 for q in self.questions_asked 
                                  if any(kw in q for kw in quantified_keywords))
        if quantified_questions > 0:
            depth += 10
        
        # æ£€æŸ¥é‰´åˆ«è¯Šæ–­ç›¸å…³é—®é¢˜
        differential_keywords = ["åŠ é‡", "ç¼“è§£", "åƒé¥­", "è¿åŠ¨", "å§¿åŠ¿", "æ—¶é—´", "æ‰©æ•£"]
        differential_questions = sum(1 for q in self.questions_asked 
                                    if any(kw in q for kw in differential_keywords))
        if differential_questions >= 2:
            depth += 10
        
        # æ£€æŸ¥å±é™©å¾è±¡ç­›æŸ¥
        red_flag_keywords = ["å‘çƒ§", "å‘çƒ­", "ä½“é‡", "æ„è¯†", "å‘¼å¸", "èƒ¸ç—›", "è¡€"]
        red_flag_questions = sum(1 for q in self.questions_asked 
                                if any(kw in q for kw in red_flag_keywords))
        if red_flag_questions > 0:
            depth += 10
        
        quality_report["depth_score"] = min(100, depth * 3.3)
        
        # 3. æ•ˆç‡è¯„ä¼°ï¼ˆ30åˆ†ï¼‰
        if len(self.questions_asked) == 0:
            efficiency = 0
        else:
            # é¿å…é‡å¤é—®é¢˜
            unique_ratio = len(set(self.questions_asked)) / len(self.questions_asked)
            efficiency = int(unique_ratio * 30)
            
            # æƒ©ç½šè¿‡äºæ³›æ³›çš„é—®é¢˜
            vague_keywords = ["è¿˜æœ‰ä»€ä¹ˆ", "å…¶ä»–ç—‡çŠ¶", "ä¸èˆ’æœ", "æ€ä¹ˆæ ·"]
            vague_count = sum(1 for q in self.questions_asked 
                             if any(kw in q for kw in vague_keywords))
            if vague_count > 0:
                efficiency -= vague_count * 5
        
        quality_report["efficiency_score"] = max(0, min(100, efficiency * 3.3))
        
        # ç»¼åˆè¯„åˆ†
        quality_report["overall_score"] = int(
            quality_report["completeness_score"] * 0.4 +
            quality_report["depth_score"] * 0.3 +
            quality_report["efficiency_score"] * 0.3
        )
        
        # è¯†åˆ«ç¼ºå¤±çš„å…³é”®ä¿¡æ¯ï¼ˆé¿å…é‡å¤æ·»åŠ å·²åœ¨completenessæ£€æŸ¥ä¸­æ·»åŠ çš„ï¼‰
        # æŒç»­æ—¶é—´å’Œä¸¥é‡ç¨‹åº¦åœ¨completenessè¯„ä¼°æ—¶å·²ç»æ·»åŠ åˆ°missing_areas
        
        # æ£€æŸ¥å±é™©å¾è±¡ç­›æŸ¥
        if not red_flag_questions:
            if "å±é™©å¾è±¡ç­›æŸ¥" not in quality_report["missing_areas"]:
                quality_report["missing_areas"].append("å±é™©å¾è±¡ç­›æŸ¥")
            quality_report["suggestions"].append("å»ºè®®ç­›æŸ¥çº¢æ——ç—‡çŠ¶ï¼š'æœ€è¿‘æœ‰æ²¡æœ‰å‘çƒ§ã€ä½“é‡ä¸‹é™ã€å¤œé—´ç›—æ±—ï¼Ÿ'")
        
        if not differential_questions:
            quality_report["missing_areas"].append("é‰´åˆ«è¯Šæ–­ç›¸å…³ä¿¡æ¯")
            quality_report["suggestions"].append("å»ºè®®è¯¢é—®åŠ é‡/ç¼“è§£å› ç´ ï¼š'ä»€ä¹ˆæƒ…å†µä¸‹ç—‡çŠ¶ä¼šåŠ é‡æˆ–ç¼“è§£ï¼Ÿ'")
        
        # æ£€æŸ¥æš´éœ²å²ï¼ˆæ–°å¢ï¼‰
        exposure_keywords = ["å¸çƒŸ", "æŠ½çƒŸ", "çƒŸ", "é…’", "å–é…’", "é¥®é…’", "èŒä¸š", "å·¥ä½œ", "æ¥è§¦", 
                            "åŒ–å­¦", "ç²‰å°˜", "è¾å°„", "è£…ä¿®", "å® ç‰©", "è¯ç‰©", "ä¿å¥å“", "ç”µå­çƒŸ"]
        has_exposure = any(q for q in self.questions_asked 
                          if any(kw in q for kw in exposure_keywords))
        if not has_exposure:
            quality_report["missing_areas"].append("æš´éœ²å²ï¼ˆå¸çƒŸ/é¥®é…’/èŒä¸š/ç¯å¢ƒ/è¯ç‰©ç­‰,å¸¸æ˜¯æ¼è¯Šçº¿ç´¢ï¼‰")
            quality_report["suggestions"].append("å»ºè®®è¯¢é—®æš´éœ²å²ï¼š'æ‚¨å¹³æ—¶å¸çƒŸæˆ–ä½¿ç”¨ç”µå­çƒŸå—ï¼Ÿæœ‰æ²¡æœ‰ç‰¹æ®Šçš„èŒä¸šæ¥è§¦ï¼Ÿ'")
        
        # è­¦å‘Šï¼ˆä¸ç›´æ¥æ˜¾ç¤ºï¼Œç”±è°ƒç”¨æ–¹è®°å½•åˆ°detail_loggerï¼‰
        if quality_report["overall_score"] < 50:
            quality_report["warning"] = f"é—®è¯Šè´¨é‡åä½ï¼ˆ{quality_report['overall_score']}/100ï¼‰ï¼Œå»ºè®®è¡¥å……å…³é”®ä¿¡æ¯"
        elif quality_report["overall_score"] < 70:
            quality_report["warning"] = f"é—®è¯Šè´¨é‡ä¸­ç­‰ï¼ˆ{quality_report['overall_score']}/100ï¼‰ï¼Œå¯è¿›ä¸€æ­¥å®Œå–„"
        else:
            quality_report["warning"] = f"é—®è¯Šè´¨é‡è‰¯å¥½ï¼ˆ{quality_report['overall_score']}/100ï¼‰"
        
        return quality_report
    
    def decide_tests(self) -> list[dict[str, Any]]:
        """æ ¹æ®æ”¶é›†çš„ä¿¡æ¯å†³å®šéœ€è¦åšå“ªäº›æ£€æŸ¥"""
        # æ£€ç´¢æ£€æŸ¥æŒ‡å—
        chunks = self._retriever.retrieve(
            f"{self.dept} æ£€æŸ¥ é€‚åº”ç—‡ {self.collected_info.get('chief_complaint', '')}",
            filters={"dept": self.dept, "type": "plan"},
            k=4
        )
        
        kb_context = self._format_chunks(chunks)
        
        system_prompt = f"""ä½ æ˜¯{self._dept_name()}åŒ»ç”Ÿï¼Œéœ€è¦æ ¹æ®é—®è¯Šç»“æœå†³å®šæ£€æŸ¥é¡¹ç›®ã€‚

ã€æ”¶é›†çš„ä¿¡æ¯ã€‘
{json.dumps(self.collected_info, ensure_ascii=False, indent=2)}

ã€æ£€æŸ¥æŒ‡å—ã€‘
{kb_context}

ã€ä»»åŠ¡ã€‘
æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œé€‰æ‹©å¿…è¦çš„æ£€æŸ¥é¡¹ç›®ã€‚æ¯é¡¹æ£€æŸ¥éœ€è¦è¯´æ˜ç†ç”±ã€‚
"""
        
        user_prompt = '''è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "ordered_tests": [
    {"name": "æ£€æŸ¥åç§°", "type": "lab/imaging/endoscopy", "reason": "å¼€å•ç†ç”±", "priority": "routine/urgent"}
  ]
}'''
        
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                temperature=0.2
            )
            return obj.get("ordered_tests", [])
        except Exception as e:
            self._logger.error(f"âŒ æ£€æŸ¥å¼€å•å¤±è´¥: {e}")
            return []
    
    def make_diagnosis(self, test_results: list[dict[str, Any]] | None = None) -> dict[str, Any]:
        """ç»¼åˆåˆ†æååšå‡ºè¯Šæ–­"""
        # æ£€ç´¢è¯Šç–—æŒ‡å—
        chunks = self._retriever.retrieve(
            f"{self.dept} è¯Šæ–­ æ²»ç–—æ–¹æ¡ˆ {self.collected_info.get('chief_complaint', '')}",
            filters={"dept": self.dept, "type": "plan"},
            k=4
        )
        
        kb_context = self._format_chunks(chunks)
        
        test_summary = json.dumps(test_results, ensure_ascii=False) if test_results else "å°šæ— æ£€æŸ¥ç»“æœ"
        
        system_prompt = f"""ä½ æ˜¯{self._dept_name()}åŒ»ç”Ÿï¼Œéœ€è¦åšå‡ºè¯Šæ–­å¹¶åˆ¶å®šæ²»ç–—æ–¹æ¡ˆã€‚

ã€é—®è¯Šä¿¡æ¯ã€‘
{json.dumps(self.collected_info, ensure_ascii=False, indent=2)}

ã€æ£€æŸ¥ç»“æœã€‘
{test_summary}

ã€è¯Šç–—æŒ‡å—ã€‘
{kb_context}

ã€è¯Šæ–­è¦æ±‚ - ä¸´åºŠæ¨ç†æ¡†æ¶ã€‘

âš ï¸ **å¼ºåˆ¶è¦æ±‚**ï¼šå¿…é¡»å®Œæˆä»¥ä¸‹ä¸´åºŠæ¨ç†æ­¥éª¤ï¼Œå¦åˆ™è¯Šæ–­è´¨é‡ä¸åˆæ ¼

ğŸ” **æ­¥éª¤1ï¼šè¯æ®æ”¶é›†ä¸æ•´ç†**
- åˆ—å‡ºæ‰€æœ‰æ”¯æŒæ€§è¯æ®ï¼ˆç—‡çŠ¶ã€ä½“å¾ã€æ£€æŸ¥ç»“æœï¼‰
- åˆ—å‡ºæ‰€æœ‰çŸ›ç›¾æ€§è¯æ®ï¼ˆä¸æ”¯æŒå½“å‰è¯Šæ–­çš„ä¿¡æ¯ï¼‰
- è¯„ä¼°è¯æ®çš„å¯é æ€§å’Œæƒé‡

ğŸ§  **æ­¥éª¤2ï¼šé‰´åˆ«è¯Šæ–­æ€ç»´**ï¼ˆå¿…é¡»å®Œæˆï¼ï¼‰
- **è‡³å°‘åˆ—å‡º3ä¸ªé‰´åˆ«è¯Šæ–­**ï¼ŒåŒ…æ‹¬ï¼š
  * æœ€å¯èƒ½çš„è¯Šæ–­ï¼ˆä¸»è¯Šæ–­ï¼‰
  * éœ€è¦æ’é™¤çš„ä¸¥é‡ç–¾ç—…ï¼ˆå¦‚è‚¿ç˜¤ã€æ€¥ç—‡ï¼‰
  * æœ€å¸¸è§çš„ç›¸ä¼¼ç–¾ç—…
- âš ï¸ **é¿å…æ€ç»´å®šåŠ¿ - å¤šç³»ç»Ÿè€ƒè™‘**ï¼š
  * èƒ¸ç—›ï¼šä¸ä»…è€ƒè™‘å¿ƒè„ï¼Œè¿˜éœ€è€ƒè™‘è‚ºã€é£Ÿç®¡ã€èƒ¸å£ã€å¿ƒç†
  * è…¹ç—›ï¼šä¸ä»…è€ƒè™‘èƒƒè‚ ï¼Œè¿˜éœ€è€ƒè™‘æ³Œå°¿ã€å¦‡ç§‘ã€è¡€ç®¡ã€ä»£è°¢
  * å¤´ç—›ï¼šä¸ä»…è€ƒè™‘ç¥ç»ï¼Œè¿˜éœ€è€ƒè™‘çœ¼ç§‘ã€è€³é¼»å–‰ã€è¡€ç®¡ã€ä¸­æ¯’
  * **æ£€æŸ¥æš´éœ²å²**ï¼šèŒä¸šç—…ã€ä¸­æ¯’ã€è¯ç‰©ä¸è‰¯ååº”å¸¸è¢«æ¼è¯Š
- å¯¹æ¯ä¸ªé‰´åˆ«è¯Šæ–­ï¼Œè¯´æ˜ï¼š
  * æ”¯æŒè¯¥è¯Šæ–­çš„è¯æ®
  * ä¸æ”¯æŒè¯¥è¯Šæ–­çš„è¯æ®
  * å¦‚ä½•é€šè¿‡è¿›ä¸€æ­¥æ£€æŸ¥é‰´åˆ«

âš–ï¸ **æ­¥éª¤3ï¼šè¯Šæ–­æ¨ç†**
- è§£é‡Šä¸ºä»€ä¹ˆé€‰æ‹©æŸä¸ªè¯Šæ–­ä½œä¸ºä¸»è¯Šæ–­
- è¯´æ˜æ’é™¤å…¶ä»–è¯Šæ–­çš„ç†ç”±
- è¯„ä¼°è¯Šæ–­çš„ç¡®å®šæ€§ï¼ˆé«˜/ä¸­/ä½ï¼‰
- æŒ‡å‡ºè¯Šæ–­ä¸­çš„ä¸ç¡®å®šå› ç´ 

ğŸ“‹ **æ­¥éª¤4ï¼šè¾“å‡ºè¯Šæ–­**
1. **ä¸»è¯Šæ–­**ï¼šä¸€ä¸ªæœ€ç¡®å®šçš„è¯Šæ–­ï¼ˆç®€æ´æ˜ç¡®ï¼Œâ‰¤20å­—ï¼‰
2. **é‰´åˆ«è¯Šæ–­**ï¼š2-3ä¸ªéœ€è¦æ’é™¤çš„ç–¾ç—…ï¼ˆæ˜ç¡®åˆ—å‡ºï¼‰
3. **è¯Šæ–­ä¾æ®**ï¼šåˆ—ä¸¾å…³é”®è¯æ®ï¼ˆç—‡çŠ¶+æ£€æŸ¥ï¼‰
4. **ä¸ç¡®å®šå› ç´ **ï¼šåˆ—å‡ºè¯Šæ–­ä¸­çš„ç–‘ç‚¹æˆ–éœ€è¦è¿›ä¸€æ­¥æ˜ç¡®çš„é—®é¢˜
5. **è¿›ä¸€æ­¥æ£€æŸ¥å»ºè®®**ï¼šå¦‚æœè¯Šæ–­ä¸ç¡®å®šï¼Œå»ºè®®å“ªäº›æ£€æŸ¥å¯ä»¥æ˜ç¡®

ğŸš« **ç¦æ­¢**ï¼š
- é¿å…ä½¿ç”¨"ç–‘ä¼¼"ã€"å¯èƒ½"ã€"å¾…æŸ¥"ç­‰æ¨¡ç³Šè¡¨è¿°ï¼ˆé™¤éç¡®å®æ— æ³•ç¡®å®šï¼‰
- ä¸è¦åªç»™ä¸€ä¸ªè¯Šæ–­ä¸è€ƒè™‘é‰´åˆ«
- ä¸è¦å¿½ç•¥çŸ›ç›¾çš„è¯æ®
- ä¸è¦ç»™å‡ºè¿‡åº¦å…·ä½“çš„è¯Šæ–­ï¼ˆå¦‚æœè¯æ®ä¸è¶³ï¼‰

ã€ä»»åŠ¡ã€‘
ç»¼åˆåˆ†æå¹¶ç»™å‡ºè¯Šæ–­å’Œæ²»ç–—å»ºè®®ã€‚
"""
        
        user_prompt = '''è¾“å‡ºJSONæ ¼å¼ï¼ˆå¿…é¡»åŒ…å«å®Œæ•´çš„é‰´åˆ«è¯Šæ–­æ¨ç†ï¼‰ï¼š
{
  "diagnosis": {
    "name": "ä¸€ä¸ªæ˜ç¡®çš„ä¸»è¦è¯Šæ–­åç§°",
    "confidence": "high/medium/low",
    "evidence": ["æ”¯æŒè¯æ®1", "æ”¯æŒè¯æ®2", "æ”¯æŒè¯æ®3"],
    "differential": [
      {"disease": "é‰´åˆ«è¯Šæ–­1", "support": "æ”¯æŒä¾æ®", "against": "æ’é™¤ç†ç”±"},
      {"disease": "é‰´åˆ«è¯Šæ–­2", "support": "æ”¯æŒä¾æ®", "against": "æ’é™¤ç†ç”±"},
      {"disease": "é‰´åˆ«è¯Šæ–­3", "support": "æ”¯æŒä¾æ®", "against": "æ’é™¤ç†ç”±"}
    ],
    "reasoning": "ä¸ºä»€ä¹ˆé€‰æ‹©ä¸»è¯Šæ–­çš„æ¨ç†è¿‡ç¨‹ï¼ˆ200-300å­—ï¼‰",
    "uncertainty": "è¯Šæ–­ä¸­çš„ä¸ç¡®å®šå› ç´ ",
    "further_tests": ["å»ºè®®çš„è¿›ä¸€æ­¥æ£€æŸ¥"]
  },
  "treatment_plan": {
    "medications": ["ç”¨è¯1", "ç”¨è¯2"],
    "lifestyle": ["ç”Ÿæ´»å»ºè®®1"],
    "followup": "éšè®¿è®¡åˆ’"
  }
}'''
        
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                temperature=0.2
            )
            return obj
        except Exception as e:
            self._logger.error(f"âŒ è¯Šæ–­å¤±è´¥: {e}")
            return {
                "diagnosis": {"name": "è¯Šæ–­å¤±è´¥", "confidence": "low", "differential": []},
                "treatment_plan": {"medications": [], "lifestyle": [], "followup": ""}
            }
    
    def _dept_name(self) -> str:
        """æ ¹æ®ç§‘å®¤ä»£ç è¿”å›ç§‘å®¤ä¸­æ–‡å"""
        dept_names = {
            "neurology": "ç¥ç»åŒ»å­¦",
            "traditional_chinese_medicine": "ä¸­åŒ»ç§‘",
        }
        return dept_names.get(self.dept, "é€šç”¨ç§‘å®¤")
    
    def _format_chunks(self, chunks: list[dict[str, Any]]) -> str:
        """æ ¼å¼åŒ–RAGæ£€ç´¢ç»“æœ"""
        lines = []
        for i, c in enumerate(chunks[:4], 1):
            text = str(c.get("text", "")).strip()
            # ä¿ç•™å®Œæ•´ä¿¡æ¯ï¼Œåªåœ¨è¿‡é•¿æ—¶æˆªæ–­ï¼ˆ500å­—ç¬¦ï¼‰
            if len(text) > 500:
                text = text[:500] + "..."
            lines.append(f"{i}. [{c.get('doc_id')}] {text}")
        return "\n".join(lines)
    
    def get_interaction_summary(self) -> dict[str, Any]:
        """è·å–åŒ»ç”Ÿé—®è¯Šæ‘˜è¦"""
        conversation_history = self.collected_info.get("conversation_history", [])
        return {
            "questions_count": len(self.questions_asked),
            "qa_pairs": [
                {"question": conv.get("question", ""), "answer": conv.get("answer", "")}
                for conv in conversation_history
            ],
            "collected_info": self.collected_info
        }
    
    def summarize_chief_complaint(self) -> str:
        """ä»é—®è¯Šä¸­æ€»ç»“æ‚£è€…ä¸»è¯‰
        
        åŒ»ç”Ÿé€šè¿‡é—®è¯Šå’Œæ‚£è€…æè¿°ï¼Œæ€»ç»“å‡ºç®€æ´çš„ä¸»è¯‰
        
        Returns:
            æ€»ç»“çš„ä¸»è¯‰å­—ç¬¦ä¸²
        """
        conversation_history = self.collected_info.get("conversation_history", [])
        if not self.questions_asked or not conversation_history:
            return "æ‚£è€…ä¸»è¯‰ä¸æ˜"
        
        # LLMæ¨¡å¼ï¼šæ™ºèƒ½æ€»ç»“ï¼ˆåªä½¿ç”¨å‰5è½®ï¼‰
        qa_text = "\n".join([
            f"åŒ»ç”Ÿï¼š{conv.get('question', '')}\næ‚£è€…ï¼š{conv.get('answer', '')}"
            for conv in conversation_history[:5]
        ])
        
        system_prompt = f"""ä½ æ˜¯ä¸€å{self._dept_name()}åŒ»ç”Ÿï¼Œéœ€è¦æ ¹æ®é—®è¯Šè®°å½•æ€»ç»“æ‚£è€…çš„ä¸»è¯‰ã€‚

ã€é—®è¯Šè®°å½•ã€‘
{qa_text}

ã€ä»»åŠ¡ã€‘
æ€»ç»“æ‚£è€…çš„æ ¸å¿ƒä¸»è¯‰ï¼ˆchief complaintï¼‰ï¼Œè¦æ±‚ï¼š
1. ç®€æ´æ˜ç¡®ï¼Œä¸€èˆ¬10-30å­—
2. åŒ…å«ä¸»è¦ç—‡çŠ¶ã€éƒ¨ä½ã€æ—¶é—´
3. ä½¿ç”¨åŒ»å­¦æœ¯è¯­ï¼Œä½†ä¿æŒå¯è¯»æ€§
4. æ ¼å¼ç¤ºä¾‹ï¼š"åå¤ä¸Šè…¹ç—›3å¤©" "å¤´ç—›ä¼´æ¶å¿ƒå‘•å2å‘¨" "å‘çƒ­å’³å—½5å¤©"

ä¸è¦åŒ…å«æ£€æŸ¥ç»“æœã€è¯Šæ–­æ¨æµ‹ï¼Œåªæè¿°æ‚£è€…çš„ä¸»è§‚ç—‡çŠ¶ã€‚
"""
        
        user_prompt = 'è¯·æ€»ç»“ä¸»è¯‰ï¼Œè¾“å‡ºJSONæ ¼å¼ï¼š{"chief_complaint": "æ€»ç»“çš„ä¸»è¯‰"}'
        
        try:
            obj, _, _ = self._llm.generate_json(
                system_prompt=system_prompt,
                user_prompt=user_prompt,
                temperature=0.1
            )
            return obj.get("chief_complaint", "æ‚£è€…ä¸»è¯‰ä¸æ˜")
        except Exception:
            # LLMå¤±è´¥æ—¶ä½¿ç”¨ç¬¬ä¸€ä¸ªå›ç­”
            first_answer = conversation_history[0].get("answer", "") if conversation_history else ""
            return first_answer[:50] if first_answer else "æ‚£è€…ä¸»è¯‰ä¸æ˜"
